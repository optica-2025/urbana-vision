<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Admin - Urbana Vision Pro</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -webkit-system-font, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #134e4a 0%, #7c2d12 100%); 
            color: white; 
            padding: 20px;
            min-height: 100vh;
            overflow-x: hidden;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { 
            background: rgba(255, 255, 255, 0.1); 
            padding: 20px; 
            border-radius: 10px; 
            text-align: center; 
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }
        .btn {
            display: inline-block;
            padding: 12px 20px;
            margin: 5px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            font-weight: bold;
            text-decoration: none;
            color: white;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            background: linear-gradient(45deg, #10b981, #059669);
        }
        .btn:hover { transform: translateY(-2px); opacity: 0.9; }
        .btn:active { transform: translateY(0); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-primary { background: linear-gradient(45deg, #10b981, #059669); }
        .btn-danger { background: linear-gradient(45deg, #ef4444, #dc2626); }
        .btn-secondary { background: linear-gradient(45deg, #666, #555); }
        .btn-whatsapp { background: linear-gradient(45deg, #25d366, #20c55e); }
        .btn-warning { background: linear-gradient(45deg, #f59e0b, #d97706); }
        .btn-success { background: linear-gradient(45deg, #059669, #047857); }
        .section {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .section.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }
        .card {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.2s ease;
        }
        .card:hover { transform: translateY(-2px); }
        .input, .select, .textarea {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 2px solid rgba(255, 255, 255, 0.2);
            background: rgba(0, 0, 0, 0.3);
            color: white;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        .input:focus, .select:focus, .textarea:focus {
            outline: none;
            border-color: #10b981;
            background: rgba(0, 0, 0, 0.5);
        }
        .input::placeholder, .textarea::placeholder { color: rgba(255, 255, 255, 0.6); }
        .textarea { min-height: 100px; resize: vertical; font-family: inherit; }
        .table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: rgba(0,0,0,0.4);
            border-radius: 10px;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }
        .table th, .table td {
            padding: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            text-align: left;
        }
        .table th {
            background: rgba(0, 0, 0, 0.6);
            font-weight: bold;
            color: #10b981;
        }
        .table tr:hover { background: rgba(255, 255, 255, 0.05); }
        .alert {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(45deg, #10b981, #059669);
            padding: 15px 20px;
            border-radius: 10px;
            display: none;
            z-index: 9999;
            max-width: 350px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            animation: slideInRight 0.3s ease;
        }
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .camera-box {
            width: 100%;
            height: 200px;
            background: linear-gradient(45deg, #000, #333);
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 10px 0;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .camera-box:hover { 
            border-color: #10b981; 
            background: linear-gradient(45deg, #134e4a, #000);
        }
        .camera-box.active { border-color: #10b981; animation: pulse 2s infinite; }
        .product-img {
            width: 100px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        .stat-box {
            background: linear-gradient(45deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.2));
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin: 10px 0;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        .stat-number {
            font-size: 36px;
            font-weight: bold;
            color: #10b981;
            display: block;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        .numero-orden {
            background: linear-gradient(45deg, #10b981, #059669);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }
        .estado-orden {
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            text-align: center;
            margin: 5px 0;
            display: inline-block;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        .estado-pendiente { background: linear-gradient(45deg, #f59e0b, #d97706); }
        .estado-listo { background: linear-gradient(45deg, #10b981, #059669); }
        .estado-entregado { background: linear-gradient(45deg, #6b7280, #4b5563); }
        .prescripcion-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 15px 0;
        }
        .ojo-section {
            background: rgba(0, 0, 0, 0.4);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .reminder-item {
            background: rgba(0, 0, 0, 0.4);
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border-left: 4px solid #10b981;
            backdrop-filter: blur(10px);
        }
        .reminder-urgent {
            border-left-color: #ef4444;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        .cliente-item {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            margin: 8px 0;
            border-radius: 8px;
            border-left: 3px solid #10b981;
            backdrop-filter: blur(10px);
        }
        .footer {
            position: fixed;
            bottom: 10px;
            right: 25px;
            font-size: 10px;
            font-weight: 600;
            opacity: 0.7;
            background: linear-gradient(45deg, #8B4513, #DAA520);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .edad-display {
            background: linear-gradient(45deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.2));
            padding: 12px;
            border-radius: 8px;
            margin: 8px 0;
            font-weight: bold;
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        .backup-status {
            position: fixed;
            bottom: 60px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 12px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 1000;
        }
        .compatibility-warning {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            font-size: 12px;
        }
        
        /* Responsive mejorado */
        @media (max-width: 768px) {
            .grid { grid-template-columns: 1fr; }
            .prescripcion-grid { grid-template-columns: 1fr; }
            .container { padding: 10px; }
            body { padding: 10px; }
            .btn { padding: 10px 15px; font-size: 12px; }
            .header { padding: 15px; }
            .card { padding: 15px; }
        }
        
        @media (max-width: 480px) {
            .alert { right: 10px; max-width: calc(100vw - 20px); }
            .backup-status { right: 10px; bottom: 50px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚öôÔ∏è URBANA VISION PRO</h1>
            <p>Sistema Profesional de Gesti√≥n con Laboratorio Integrado</p>
            <div style="margin-top: 10px;">
                <span id="status-indicator" style="color: #10b981;">üîÑ Iniciando...</span>
            </div>
            <div id="compatibility-info" class="compatibility-warning" style="display: none;"></div>
        </div>

        <!-- MEN√ö PRINCIPAL -->
        <div id="menu" class="section active">
            <div class="grid">
                <div class="card">
                    <h3>üìä Dashboard</h3>
                    <div class="stat-box">
                        <span class="stat-number" id="totalProductos">0</span>
                        <div>Productos</div>
                    </div>
                    <div class="stat-box">
                        <span class="stat-number" id="totalClientes">0</span>
                        <div>Clientes</div>
                    </div>
                    <div class="stat-box">
                        <span class="stat-number">RD$ <span id="ventasHoy">0</span></span>
                        <div>Ventas Hoy</div>
                    </div>
                </div>

                <div class="card">
                    <h3>üì¶ Inventario</h3>
                    <button class="btn btn-primary" onclick="navigateToSection('inventario')">üì¶ Ver Inventario</button>
                    <button class="btn btn-primary" onclick="navigateToSection('camara')">üì∑ C√°mara R√°pida</button>
                    <button class="btn btn-secondary" onclick="navigateToSection('catalogo')">üõçÔ∏è Ver Cat√°logo</button>
                </div>

                <div class="card">
                    <h3>üë• Gesti√≥n</h3>
                    <button class="btn btn-primary" onclick="navigateToSection('clientes')">üë• Clientes</button>
                    <button class="btn btn-primary" onclick="navigateToSection('recordatorios')">üîî Recordatorios</button>
                    <button class="btn btn-secondary" onclick="navigateToSection('ventas')">üí∞ Ventas</button>
                </div>

                <div class="card">
                    <h3>üì± Marketing</h3>
                    <button class="btn btn-primary" onclick="navigateToSection('marketing')">üì± Marketing WhatsApp</button>
                    <button class="btn btn-warning" onclick="navigateToSection('contactar')">üí¨ Contactar Clientes</button>
                    <button class="btn btn-secondary" onclick="navigateToSection('campanas')">üì£ Campa√±as</button>
                </div>

                <div class="card" style="background: linear-gradient(45deg, #134e4a, #7c2d12); border: 2px solid #10b981;">
                    <h3>üî¨ Sistema de Laboratorio</h3>
                    <button class="btn btn-primary" onclick="navigateToSection('dashboardLab')">üìä Dashboard Lab</button>
                    <button class="btn btn-primary" onclick="navigateToSection('nuevaOrden')">‚ûï Nueva Orden</button>
                    <button class="btn btn-primary" onclick="navigateToSection('ordenes')">üìã Ver √ìrdenes</button>
                    <button class="btn btn-warning" onclick="navigateToSection('cotejo')">‚úÖ Cotejo</button>
                    <button class="btn btn-success" onclick="navigateToSection('cobrar')">üí∞ Cuentas x Cobrar</button>
                    <button class="btn btn-danger" onclick="navigateToSection('pagar')">üí∏ Cuentas x Pagar</button>
                </div>

                <div class="card">
                    <h3>üìÑ Documentos</h3>
                    <button class="btn btn-primary" onclick="navigateToSection('facturaProforma')">üìÑ Factura Proforma</button>
                    <button class="btn btn-primary" onclick="openExternalLink('https://urbanavision.com/ncf')">üßæ NCF</button>
                    <button class="btn btn-secondary" onclick="navigateToSection('reportes')">üìä Reportes</button>
                </div>

                <div class="card">
                    <h3>üíæ Backup Avanzado</h3>
                    <button class="btn btn-success" onclick="createAdvancedBackup()">üíæ Backup Completo</button>
                    <button class="btn btn-warning" onclick="exportToCloud()">‚òÅÔ∏è Subir a Nube</button>
                    <button class="btn btn-primary" onclick="downloadBackup()">üì± Descargar al M√≥vil</button>
                    <button class="btn btn-secondary" onclick="importBackup()">üì• Importar Backup</button>
                    <div style="margin-top: 10px; font-size: 12px; opacity: 0.8;">
                        üîÑ Auto-backup cada 30min<br>
                        üì± Local + ‚òÅÔ∏è Nube
                    </div>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-danger" onclick="openExternalLink('https://urbanavision.com')">üè† Volver al Inicio</button>
            </div>
        </div>

        <!-- FACTURA PROFORMA -->
        <div id="facturaProforma" class="section">
            <h2>üìÑ Factura Proforma</h2>
            <button class="btn btn-secondary" onclick="navigateToSection('menu')">‚¨ÖÔ∏è Volver</button>
            
            <div class="grid">
                <div class="card">
                    <h3>üë§ Cliente</h3>
                    <select id="clienteFactura" class="select">
                        <option value="">Seleccionar cliente</option>
                    </select>
                    <input type="text" id="nombreClienteFactura" class="input" placeholder="Nombre del cliente" readonly>
                    <input type="text" id="telefonoClienteFactura" class="input" placeholder="Tel√©fono" readonly>
                </div>
                
                <div class="card">
                    <h3>üëì Examen Visual</h3>
                    <div style="background: linear-gradient(45deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.2)); padding: 15px; border-radius: 10px; margin: 10px 0; border: 1px solid #10b981;">
                        <h4>‚úÖ EXAMEN VISUAL GRATIS</h4>
                        <p>Incluido sin costo adicional</p>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>üõçÔ∏è Productos y Servicios</h3>
                <div style="margin: 15px 0;">
                    <h4>Agregar Producto/Servicio:</h4>
                    <div class="grid">
                        <input type="text" id="descripcionItem" class="input" placeholder="Descripci√≥n del producto/servicio">
                        <input type="number" id="precioItem" class="input" placeholder="Precio RD$" step="0.01">
                        <input type="number" id="cantidadItem" class="input" placeholder="Cantidad" value="1" min="1">
                    </div>
                    <textarea id="comentarioItem" class="textarea" placeholder="Comentarios sobre el precio (ej: Precio negociable, oferta especial, descuento aplicable, etc.)"></textarea>
                    <button class="btn btn-primary" onclick="addItemToInvoice()">‚ûï Agregar Item</button>
                </div>
                
                <div id="listaItemsFactura" style="margin: 20px 0;"></div>
                
                <div style="background: linear-gradient(45deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.1)); padding: 15px; border-radius: 10px; margin: 15px 0; border: 1px solid #10b981;">
                    <h4>üí∞ Resumen de Factura</h4>
                    <div style="display: flex; justify-content: space-between; margin: 10px 0;">
                        <span>Subtotal:</span>
                        <span id="subtotalFactura">RD$ 0.00</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin: 10px 0;">
                        <span>Examen Visual:</span>
                        <span style="color: #10b981;">GRATIS</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin: 10px 0; font-size: 18px; font-weight: bold; border-top: 1px solid rgba(255, 255, 255, 0.2); padding-top: 10px;">
                        <span>TOTAL:</span>
                        <span id="totalFactura">RD$ 0.00</span>
                    </div>
                </div>
                
                <div style="text-align: center;">
                    <button class="btn btn-whatsapp" onclick="sendProformaInvoice()">üì± Enviar Factura</button>
                    <button class="btn btn-secondary" onclick="clearInvoice()">üîÑ Limpiar</button>
                </div>
            </div>
        </div>

        <!-- CAT√ÅLOGO -->
        <div id="catalogo" class="section">
            <h2>üõçÔ∏è Cat√°logo de Productos</h2>
            <button class="btn btn-secondary" onclick="navigateToSection('menu')">‚¨ÖÔ∏è Volver</button>
            
            <div style="margin: 20px 0;">
                <input type="text" id="buscarCatalogo" class="input" placeholder="üîç Buscar en cat√°logo..." onkeyup="searchInCatalog(this.value)">
            </div>
            
            <div id="listaCatalogo"></div>
        </div>

        <!-- OTROS MODALES/SECCIONES (simplificado para el ejemplo) -->
        <div id="inventario" class="section">
            <h2>üì¶ Inventario</h2>
            <button class="btn btn-secondary" onclick="navigateToSection('menu')">‚¨ÖÔ∏è Volver</button>
            <div id="listaProductos"></div>
        </div>

        <div id="clientes" class="section">
            <h2>üë• Gesti√≥n de Clientes</h2>
            <button class="btn btn-secondary" onclick="navigateToSection('menu')">‚¨ÖÔ∏è Volver</button>
            <div id="listaClientes"></div>
        </div>

        <!-- M√°s secciones aqu√≠... -->

    </div>

    <div class="alert" id="alert"></div>
    <div class="backup-status" id="backupStatus">üíæ Sistema listo</div>
    <div class="footer">by fbrugal jrubinstein consultores</div>

    <script>
        // ========================================
        // üõ°Ô∏è VARIABLES GLOBALES Y CONFIGURACI√ìN
        // ========================================
        
        'use strict';

        // Variables globales con inicializaci√≥n segura
        let productos = [];
        let clientes = [];
        let ordenesLab = [];
        let ventas = [];
        let estadisticas = { mensajesHoy: 0, promociones: 0, audiosHoy: 0 };
        let contadorOrdenes = 1;
        let streams = new Map();
        let fotos = new Map();
        let itemsFactura = [];
        
        // Variables de audio
        let mediaRecorder = null;
        let audioChunks = [];
        let audioBlob = null;
        let tiempoInicio = null;
        let intervalotiempo = null;
        
        // Sistema de logs
        let systemLogs = [];
        let isSystemReady = false;
        
        // Detectar capacidades del navegador
        let browserCapabilities = {
            localStorage: false,
            camera: false,
            audio: false,
            share: false,
            download: false,
            clipboard: false
        };

        // ========================================
        // üîç FUNCIONES AUXILIARES B√ÅSICAS
        // ========================================
        
        function logSystem(message, data = null) {
            try {
                const timestamp = new Date().toISOString();
                const logEntry = {
                    timestamp,
                    message,
                    data: data ? JSON.stringify(data) : null
                };
                
                systemLogs.push(logEntry);
                
                // Mantener solo los √∫ltimos 100 logs
                if (systemLogs.length > 100) {
                    systemLogs = systemLogs.slice(-100);
                }
                
                console.log(`[${timestamp}] ${message}`, data || '');
            } catch (error) {
                console.error('Error en sistema de logs:', error);
            }
        }

        function getElement(id) {
            try {
                if (typeof id !== 'string' || id.trim() === '') {
                    logSystem('‚ùå ID de elemento inv√°lido', id);
                    return null;
                }
                
                const element = document.getElementById(id);
                if (!element) {
                    logSystem(`‚ö†Ô∏è Elemento no encontrado: ${id}`);
                }
                return element;
            } catch (error) {
                logSystem(`‚ùå Error obteniendo elemento ${id}`, error);
                return null;
            }
        }

        function setContent(id, content, isHTML = false) {
            try {
                const element = getElement(id);
                if (!element) return false;
                
                if (isHTML) {
                    element.innerHTML = content || '';
                } else {
                    element.textContent = content || '';
                }
                return true;
            } catch (error) {
                logSystem(`‚ùå Error estableciendo contenido en ${id}`, error);
                return false;
            }
        }

        function getValue(id) {
            try {
                const element = getElement(id);
                return element ? (element.value || '') : '';
            } catch (error) {
                logSystem(`‚ùå Error obteniendo valor de ${id}`, error);
                return '';
            }
        }

        function setValue(id, value) {
            try {
                const element = getElement(id);
                if (element) {
                    element.value = value || '';
                    return true;
                }
                return false;
            } catch (error) {
                logSystem(`‚ùå Error estableciendo valor en ${id}`, error);
                return false;
            }
        }

        function showAlert(mensaje) {
            try {
                const alert = getElement('alert');
                if (alert) {
                    alert.textContent = mensaje;
                    alert.style.display = 'block';
                    setTimeout(() => {
                        alert.style.display = 'none';
                    }, 4000);
                }
                console.log('üîî', mensaje);
            } catch (error) {
                console.error('‚ùå Error mostrando alerta:', error);
            }
        }

        function escapeHtml(text) {
            if (typeof text !== 'string') return text;
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        // ========================================
        // üöÄ NAVEGACI√ìN PRINCIPAL
        // ========================================
        
        function navigateToSection(seccion) {
            try {
                if (!isSystemReady) {
                    showAlert('‚è≥ Sistema a√∫n cargando, espere...');
                    return;
                }
                
                if (typeof seccion !== 'string' || seccion.trim() === '') {
                    logSystem('‚ùå Secci√≥n inv√°lida', seccion);
                    return;
                }
                
                // Ocultar todas las secciones
                document.querySelectorAll('.section').forEach(s => {
                    if (s && s.classList) {
                        s.classList.remove('active');
                    }
                });
                
                // Mostrar la secci√≥n seleccionada
                const elemento = getElement(seccion);
                if (elemento) {
                    elemento.classList.add('active');
                    
                    // Cargar datos espec√≠ficos de la secci√≥n
                    loadSectionData(seccion);
                    
                    logSystem(`üìÑ Navegado a secci√≥n: ${seccion}`);
                } else {
                    logSystem(`‚ùå Secci√≥n no encontrada: ${seccion}`);
                    showAlert(`‚ùå Secci√≥n '${seccion}' no encontrada`);
                }
                
            } catch (error) {
                logSystem(`‚ùå Error navegando a ${seccion}`, error);
                showAlert('‚ùå Error de navegaci√≥n');
            }
        }

        async function loadSectionData(seccion) {
            try {
                switch(seccion) {
                    case 'menu':
                        await updateDashboard();
                        break;
                    case 'facturaProforma':
                        await loadInvoiceSelectors();
                        clearInvoice();
                        break;
                    case 'catalogo':
                        await loadCatalog();
                        break;
                    case 'inventario':
                        await loadProducts();
                        break;
                    case 'clientes':
                        await loadClients();
                        break;
                    // Agregar m√°s casos seg√∫n necesidad
                }
            } catch (error) {
                logSystem(`‚ùå Error cargando datos de secci√≥n ${seccion}`, error);
            }
        }

        // ========================================
        // üì± WHATSAPP ROBUSTO CON FALLBACKS
        // ========================================
        
        function openWhatsApp(telefono, mensaje) {
            try {
                // Validar par√°metros
                if (!mensaje || mensaje.trim() === '') {
                    logSystem('‚ùå Mensaje vac√≠o para WhatsApp');
                    showAlert('‚ùå No hay mensaje para enviar');
                    return false;
                }
                
                // Limpiar tel√©fono
                const telefonoLimpio = telefono ? telefono.replace(/[^0-9]/g, '') : '';
                
                // Validar longitud del mensaje
                if (mensaje.length > 2000) {
                    logSystem('‚ö†Ô∏è Mensaje muy largo, truncando...');
                    mensaje = mensaje.substring(0, 1950) + '\n\n...(mensaje truncado)';
                }
                
                // Escapar caracteres especiales
                const mensajeEscapado = encodeURIComponent(mensaje);
                
                // Construir URL
                const url = telefonoLimpio 
                    ? `https://wa.me/${telefonoLimpio}?text=${mensajeEscapado}`
                    : `https://wa.me/?text=${mensajeEscapado}`;
                
                // Intentar abrir con window.open
                const ventana = window.open(url, '_blank');
                
                if (!ventana || ventana.closed || typeof ventana.closed === 'undefined') {
                    // Popup bloqueado, usar fallbacks
                    return handleWhatsAppFallback(url, mensaje);
                }
                
                logSystem('‚úÖ WhatsApp abierto correctamente');
                return true;
                
            } catch (error) {
                logSystem('‚ùå Error abriendo WhatsApp', error);
                return handleWhatsAppFallback(null, mensaje);
            }
        }

        function handleWhatsAppFallback(url, mensaje) {
            try {
                // Fallback 1: Copiar al portapapeles
                if (browserCapabilities.clipboard) {
                    navigator.clipboard.writeText(mensaje).then(() => {
                        showAlert('üìã Mensaje copiado al portapapeles. P√©guelo en WhatsApp manualmente.');
                        logSystem('‚úÖ Mensaje copiado al portapapeles como fallback');
                    }).catch(() => {
                        showManualInstructions(url, mensaje);
                    });
                    return true;
                }
                
                // Fallback 2: Mostrar instrucciones manuales
                showManualInstructions(url, mensaje);
                return true;
                
            } catch (error) {
                logSystem('‚ùå Error en fallback de WhatsApp', error);
                showAlert('‚ùå No se pudo enviar el mensaje');
                return false;
            }
        }

        function showManualInstructions(url, mensaje) {
            try {
                const instrucciones = `üîó ENV√çO MANUAL DE WHATSAPP

1. Copie este mensaje:
${mensaje}

2. Abra WhatsApp manualmente
3. Pegue el mensaje
4. Env√≠e al contacto deseado

${url ? `\nEnlace directo: ${url}` : ''}`;
                
                // Mostrar en un prompt o alert
                if (confirm('¬øDesea ver las instrucciones para env√≠o manual?')) {
                    alert(instrucciones);
                }
                
                logSystem('‚ÑπÔ∏è Instrucciones manuales mostradas');
            } catch (error) {
                logSystem('‚ùå Error mostrando instrucciones', error);
            }
        }

        function openExternalLink(url) {
            try {
                if (!url || typeof url !== 'string') {
                    logSystem('‚ùå URL inv√°lida', url);
                    return;
                }
                
                const ventana = window.open(url, '_blank');
                
                if (!ventana || ventana.closed || typeof ventana.closed === 'undefined') {
                    // Popup bloqueado
                    if (browserCapabilities.clipboard) {
                        navigator.clipboard.writeText(url).then(() => {
                            showAlert('üìã Enlace copiado al portapapeles');
                        }).catch(() => {
                            showAlert(`üìé Abra manualmente: ${url}`);
                        });
                    } else {
                        showAlert(`üìé Abra manualmente: ${url}`);
                    }
                }
                
            } catch (error) {
                logSystem('‚ùå Error abriendo enlace', error);
                showAlert('‚ùå Error al abrir enlace');
            }
        }

        // ========================================
        // üíæ FUNCIONES DE DATOS
        // ========================================
        
        async function loadData() {
            try {
                if (!browserCapabilities.localStorage) {
                    logSystem('‚ö†Ô∏è LocalStorage no disponible, usando datos por defecto');
                    return;
                }
                
                productos = JSON.parse(localStorage.getItem('urbanaProductos') || '[]');
                clientes = JSON.parse(localStorage.getItem('urbanaClientes') || '[]');
                ordenesLab = JSON.parse(localStorage.getItem('urbanaOrdenesLab') || '[]');
                ventas = JSON.parse(localStorage.getItem('urbanaVentas') || '[]');
                estadisticas = JSON.parse(localStorage.getItem('urbanaEstadisticas') || '{"mensajesHoy": 0, "promociones": 0, "audiosHoy": 0}');
                contadorOrdenes = parseInt(localStorage.getItem('urbanaContador') || '1');
                
                // Validar datos cargados
                if (!Array.isArray(productos)) productos = [];
                if (!Array.isArray(clientes)) clientes = [];
                if (!Array.isArray(ordenesLab)) ordenesLab = [];
                if (!Array.isArray(ventas)) ventas = [];
                if (typeof estadisticas !== 'object') estadisticas = { mensajesHoy: 0, promociones: 0, audiosHoy: 0 };
                if (isNaN(contadorOrdenes) || contadorOrdenes < 1) contadorOrdenes = 1;
                
                // Asegurar que audiosHoy existe
                if (!estadisticas.audiosHoy) {
                    estadisticas.audiosHoy = 0;
                }
                
                logSystem('‚úÖ Datos cargados', {
                    productos: productos.length,
                    clientes: clientes.length,
                    ordenes: ordenesLab.length,
                    estadisticas: estadisticas
                });
                
            } catch (error) {
                logSystem('‚ùå Error cargando datos', error);
                await createSampleData();
            }
        }

        async function saveData() {
            try {
                if (!browserCapabilities.localStorage) {
                    logSystem('‚ö†Ô∏è LocalStorage no disponible para guardar');
                    return false;
                }
                
                // Validar datos antes de guardar
                if (!Array.isArray(productos) || !Array.isArray(clientes) || !Array.isArray(ordenesLab)) {
                    throw new Error('Datos corruptos, no se pueden guardar');
                }
                
                localStorage.setItem('urbanaProductos', JSON.stringify(productos));
                localStorage.setItem('urbanaClientes', JSON.stringify(clientes));
                localStorage.setItem('urbanaOrdenesLab', JSON.stringify(ordenesLab));
                localStorage.setItem('urbanaVentas', JSON.stringify(ventas));
                localStorage.setItem('urbanaEstadisticas', JSON.stringify(estadisticas));
                localStorage.setItem('urbanaContador', contadorOrdenes.toString());
                
                logSystem('‚úÖ Datos guardados correctamente');
                updateBackupStatus('üíæ Datos guardados');
                return true;
                
            } catch (error) {
                logSystem('‚ùå Error guardando datos', error);
                updateBackupStatus('‚ùå Error guardando');
                return false;
            }
        }

        async function createSampleData() {
            try {
                if (clientes.length === 0) {
                    clientes = [
                        { 
                            id: 1, 
                            nombre: 'Mar√≠a Gonz√°lez', 
                            telefono: '809-555-0001', 
                            email: 'maria@email.com',
                            cumpleanos: '1985-03-15',
                            notas: 'Cliente frecuente'
                        },
                        { 
                            id: 2, 
                            nombre: 'Juan P√©rez', 
                            telefono: '809-555-0002', 
                            email: 'juan@email.com',
                            cumpleanos: '1990-07-22',
                            notas: 'Usa progresivos'
                        }
                    ];
                }
                
                if (productos.length === 0) {
                    productos = [
                        {
                            id: 1,
                            codigo: 'UV001',
                            nombre: 'Montura Cl√°sica',
                            precio: 1500,
                            stock: 10,
                            categoria: 'monturas',
                            imagen: '',
                            fecha: new Date().toISOString()
                        }
                    ];
                }
                
                await saveData();
                logSystem('‚úÖ Datos de ejemplo creados');
            } catch (error) {
                logSystem('‚ùå Error creando datos de ejemplo', error);
            }
        }

        // ========================================
        // üìä DASHBOARD
        // ========================================
        
        async function updateDashboard() {
            try {
                const elementos = [
                    { id: 'totalProductos', valor: productos.length },
                    { id: 'totalClientes', valor: clientes.length },
                    { id: 'ventasHoy', valor: calculateTodaySales().toFixed(2) }
                ];
                
                elementos.forEach(el => {
                    setContent(el.id, el.valor);
                });
                
                logSystem('‚úÖ Dashboard actualizado');
            } catch (error) {
                logSystem('‚ùå Error actualizando dashboard', error);
            }
        }

        function calculateTodaySales() {
            try {
                const hoy = new Date().toDateString();
                return ventas
                    .filter(v => new Date(v.fecha).toDateString() === hoy)
                    .reduce((sum, v) => sum + (v.total || 0), 0);
            } catch (error) {
                logSystem('‚ùå Error calculando ventas hoy', error);
                return 0;
            }
        }

        // ========================================
        // üìÑ FACTURA PROFORMA
        // ========================================
        
        async function loadInvoiceSelectors() {
            try {
                const clienteFactura = getElement('clienteFactura');
                if (clienteFactura) {
                    clienteFactura.innerHTML = '<option value="">Seleccionar cliente</option>';
                    clientes.forEach(c => {
                        clienteFactura.innerHTML += `<option value="${c.id}">${escapeHtml(c.nombre)} - ${escapeHtml(c.telefono)}</option>`;
                    });
                }
                
                // Event listener para cliente
                clienteFactura.addEventListener('change', loadClientDataForInvoice);
                
                logSystem('‚úÖ Selectores de factura cargados');
            } catch (error) {
                logSystem('‚ùå Error cargando selectores factura', error);
            }
        }

        function loadClientDataForInvoice() {
            try {
                const clienteId = parseInt(getValue('clienteFactura')) || 0;
                
                if (!clienteId) {
                    setValue('nombreClienteFactura', '');
                    setValue('telefonoClienteFactura', '');
                    return;
                }
                
                const cliente = clientes.find(c => c.id === clienteId);
                if (cliente) {
                    setValue('nombreClienteFactura', cliente.nombre);
                    setValue('telefonoClienteFactura', cliente.telefono);
                }
            } catch (error) {
                logSystem('‚ùå Error cargando datos cliente factura', error);
            }
        }

        function addItemToInvoice() {
            try {
                const descripcion = getValue('descripcionItem').trim();
                const precio = parseFloat(getValue('precioItem')) || 0;
                const cantidad = parseInt(getValue('cantidadItem')) || 1;
                const comentario = getValue('comentarioItem').trim();
                
                if (!descripcion || precio <= 0) {
                    showAlert('‚ùå Complete descripci√≥n y precio');
                    return;
                }
                
                const item = {
                    id: Date.now(),
                    descripcion: descripcion,
                    precio: precio,
                    cantidad: cantidad,
                    comentario: comentario,
                    subtotal: precio * cantidad
                };
                
                itemsFactura.push(item);
                
                // Limpiar campos
                ['descripcionItem', 'precioItem', 'comentarioItem'].forEach(id => {
                    setValue(id, '');
                });
                setValue('cantidadItem', '1');
                
                updateInvoiceItemsList();
                calculateInvoiceTotal();
                
                showAlert('‚úÖ Item agregado a la factura');
                logSystem('‚úÖ Item agregado a factura', item);
            } catch (error) {
                logSystem('‚ùå Error agregando item', error);
                showAlert('‚ùå Error al agregar item');
            }
        }

        function updateInvoiceItemsList() {
            try {
                if (itemsFactura.length === 0) {
                    setContent('listaItemsFactura', '<p style="text-align: center; opacity: 0.7;">No hay items agregados</p>', true);
                    return;
                }
                
                let html = '<table class="table"><thead><tr><th>Descripci√≥n</th><th>Precio</th><th>Cant.</th><th>Subtotal</th><th>Comentario</th><th>Acci√≥n</th></tr></thead><tbody>';
                
                itemsFactura.forEach(item => {
                    html += `
                        <tr>
                            <td>${escapeHtml(item.descripcion)}</td>
                            <td>RD$ ${item.precio.toFixed(2)}</td>
                            <td>${item.cantidad}</td>
                            <td>RD$ ${item.subtotal.toFixed(2)}</td>
                            <td><small>${escapeHtml(item.comentario || 'Sin comentarios')}</small></td>
                            <td><button class="btn btn-danger" onclick="removeItemFromInvoice(${item.id})">üóëÔ∏è</button></td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                setContent('listaItemsFactura', html, true);
            } catch (error) {
                logSystem('‚ùå Error actualizando lista items', error);
            }
        }

        function removeItemFromInvoice(id) {
            try {
                itemsFactura = itemsFactura.filter(item => item.id !== id);
                updateInvoiceItemsList();
                calculateInvoiceTotal();
                showAlert('‚úÖ Item eliminado');
                logSystem('‚úÖ Item eliminado de factura', { id });
            } catch (error) {
                logSystem('‚ùå Error eliminando item', error);
            }
        }

        function calculateInvoiceTotal() {
            try {
                const subtotal = itemsFactura.reduce((sum, item) => sum + (item.subtotal || 0), 0);
                const total = subtotal; // El examen es gratis, no se suma
                
                setContent('subtotalFactura', `RD$ ${subtotal.toFixed(2)}`);
                setContent('totalFactura', `RD$ ${total.toFixed(2)}`);
            } catch (error) {
                logSystem('‚ùå Error calculando total factura', error);
            }
        }

        function sendProformaInvoice() {
            try {
                const clienteId = parseInt(getValue('clienteFactura')) || 0;
                const cliente = clientes.find(c => c.id === clienteId);
                
                if (!cliente) {
                    showAlert('‚ùå Seleccione un cliente');
                    return;
                }
                
                if (itemsFactura.length === 0) {
                    showAlert('‚ùå Agregue al menos un producto/servicio');
                    return;
                }
                
                const subtotal = itemsFactura.reduce((sum, item) => sum + (item.subtotal || 0), 0);
                const total = subtotal;
                
                let mensaje = `üìÑ *FACTURA PROFORMA*
                
üë§ *CLIENTE:* ${cliente.nombre}
üì± *TEL√âFONO:* ${cliente.telefono}
üìÖ *FECHA:* ${new Date().toLocaleDateString()}

üì¶ *PRODUCTOS/SERVICIOS:*
`;
                
                itemsFactura.forEach(item => {
                    mensaje += `
‚Ä¢ ${item.descripcion}
  Precio: RD$ ${item.precio.toFixed(2)} x ${item.cantidad}
  Subtotal: RD$ ${item.subtotal.toFixed(2)}`;
                    if (item.comentario) {
                        mensaje += `
  üí¨ ${item.comentario}`;
                    }
                    mensaje += '\n';
                });
                
                mensaje += `
üëÅÔ∏è *EXAMEN VISUAL:* ‚úÖ GRATIS

üí∞ *RESUMEN:*
‚Ä¢ Subtotal: RD$ ${subtotal.toFixed(2)}
‚Ä¢ Examen Visual: GRATIS
‚Ä¢ *TOTAL: RD$ ${total.toFixed(2)}*

üì± 809-713-5307
üåê urbanavision.com

*V√°lida por 30 d√≠as*`;
                
                if (openWhatsApp(cliente.telefono, mensaje)) {
                    showAlert('üì± Factura proforma enviada');
                    logSystem('‚úÖ Factura proforma enviada', { cliente: cliente.nombre, total });
                }
                
            } catch (error) {
                logSystem('‚ùå Error enviando factura', error);
                showAlert('‚ùå Error al enviar factura');
            }
        }

        function clearInvoice() {
            try {
                itemsFactura = [];
                
                // Limpiar selectores y campos
                ['clienteFactura', 'nombreClienteFactura', 'telefonoClienteFactura',
                 'descripcionItem', 'precioItem', 'comentarioItem'].forEach(id => {
                    setValue(id, '');
                });
                
                setValue('cantidadItem', '1');
                
                updateInvoiceItemsList();
                calculateInvoiceTotal();
                
                logSystem('‚úÖ Factura limpiada');
            } catch (error) {
                logSystem('‚ùå Error limpiando factura', error);
            }
        }

        // ========================================
        // üõçÔ∏è CAT√ÅLOGO
        // ========================================
        
        async function loadCatalog() {
            try {
                if (productos.length === 0) {
                    setContent('listaCatalogo', '<p style="text-align: center;">No hay productos en el cat√°logo. Agregue productos desde la c√°mara r√°pida.</p>', true);
                    return;
                }
                
                let html = '<div class="grid">';
                
                productos.forEach(p => {
                    const imagen = p.imagen || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="150" viewBox="0 0 200 150"><rect width="200" height="150" fill="%23666"/><text x="100" y="75" text-anchor="middle" fill="white" font-size="16">Sin foto</text></svg>';
                    
                    html += `
                        <div class="card" style="text-align: center;">
                            <img src="${imagen}" style="width: 100%; height: 150px; object-fit: cover; border-radius: 10px; margin-bottom: 10px;" 
                                 onerror="this.src='data:image/svg+xml,<svg xmlns=&quot;http://www.w3.org/2000/svg&quot; width=&quot;200&quot; height=&quot;150&quot; viewBox=&quot;0 0 200 150&quot;><rect width=&quot;200&quot; height=&quot;150&quot; fill=&quot;%23666&quot;/><text x=&quot;100&quot; y=&quot;75&quot; text-anchor=&quot;middle&quot; fill=&quot;white&quot; font-size=&quot;16&quot;>Sin foto</text></svg>'">
                            <h4>${escapeHtml(p.nombre)}</h4>
                            <p><strong>C√≥digo:</strong> ${escapeHtml(p.codigo)}</p>
                            <p><strong>Precio:</strong> RD$ ${p.precio.toFixed(2)}</p>
                            <p><strong>Stock:</strong> ${p.stock} ${p.stock < 5 ? '‚ö†Ô∏è' : '‚úÖ'}</p>
                            <p style="font-size: 12px; opacity: 0.8;"><strong>Categor√≠a:</strong> ${escapeHtml(p.categoria || 'Sin categor√≠a')}</p>
                            <button class="btn btn-whatsapp" onclick="shareProductFromCatalog(${p.id})">üì± Enviar con Foto</button>
                        </div>
                    `;
                });
                
                html += '</div>';
                setContent('listaCatalogo', html, true);
                logSystem('‚úÖ Cat√°logo cargado');
            } catch (error) {
                logSystem('‚ùå Error cargando cat√°logo', error);
            }
        }

        function searchInCatalog(termino) {
            try {
                if (!termino.trim()) {
                    loadCatalog();
                    return;
                }
                
                const filtrados = productos.filter(p => 
                    p.nombre.toLowerCase().includes(termino.toLowerCase()) ||
                    p.codigo.toLowerCase().includes(termino.toLowerCase()) ||
                    (p.categoria && p.categoria.toLowerCase().includes(termino.toLowerCase()))
                );
                
                if (filtrados.length === 0) {
                    setContent('listaCatalogo', '<p style="text-align: center;">No se encontraron productos</p>', true);
                    return;
                }
                
                let html = '<div class="grid">';
                
                filtrados.forEach(p => {
                    const imagen = p.imagen || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="150" viewBox="0 0 200 150"><rect width="200" height="150" fill="%23666"/><text x="100" y="75" text-anchor="middle" fill="white" font-size="16">Sin foto</text></svg>';
                    
                    html += `
                        <div class="card" style="text-align: center;">
                            <img src="${imagen}" style="width: 100%; height: 150px; object-fit: cover; border-radius: 10px; margin-bottom: 10px;"
                                 onerror="this.src='data:image/svg+xml,<svg xmlns=&quot;http://www.w3.org/2000/svg&quot; width=&quot;200&quot; height=&quot;150&quot; viewBox=&quot;0 0 200 150&quot;><rect width=&quot;200&quot; height=&quot;150&quot; fill=&quot;%23666&quot;/><text x=&quot;100&quot; y=&quot;75&quot; text-anchor=&quot;middle&quot; fill=&quot;white&quot; font-size=&quot;16&quot;>Sin foto</text></svg>'">
                            <h4>${escapeHtml(p.nombre)}</h4>
                            <p><strong>C√≥digo:</strong> ${escapeHtml(p.codigo)}</p>
                            <p><strong>Precio:</strong> RD$ ${p.precio.toFixed(2)}</p>
                            <p><strong>Stock:</strong> ${p.stock} ${p.stock < 5 ? '‚ö†Ô∏è' : '‚úÖ'}</p>
                            <button class="btn btn-whatsapp" onclick="shareProductFromCatalog(${p.id})">üì± Enviar con Foto</button>
                        </div>
                    `;
                });
                
                html += '</div>';
                setContent('listaCatalogo', html, true);
            } catch (error) {
                logSystem('‚ùå Error buscando en cat√°logo', error);
            }
        }

        function shareProductFromCatalog(id) {
            try {
                const producto = productos.find(p => p.id === id);
                if (!producto) {
                    showAlert('‚ùå Producto no encontrado');
                    return;
                }
                
                const mensaje = `üõçÔ∏è *PRODUCTO DISPONIBLE*

üì¶ ${producto.nombre}
üî¢ C√≥digo: ${producto.codigo}
üí∞ Precio: RD$ ${producto.precio.toFixed(2)}
üì¶ Stock: ${producto.stock} unidades
üè∑Ô∏è Categor√≠a: ${producto.categoria || 'General'}

‚ú® ¬øTe interesa verlo en la tienda?

üì± 809-713-5307
üåê urbanavision.com`;
                
                if (openWhatsApp('', mensaje)) {
                    showAlert('üì± Producto enviado');
                    logSystem('‚úÖ Producto del cat√°logo enviado', { producto: producto.nombre });
                }
                
            } catch (error) {
                logSystem('‚ùå Error compartiendo producto', error);
                showAlert('‚ùå Error al enviar producto');
            }
        }

        // ========================================
        // üíæ BACKUP AVANZADO
        // ========================================
        
        async function createAdvancedBackup() {
            try {
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                
                // Crear backup completo con metadatos
                const backupData = {
                    version: '3.0',
                    timestamp: timestamp,
                    date: new Date().toISOString(),
                    browser: navigator.userAgent,
                    capabilities: browserCapabilities,
                    data: {
                        productos: productos || [],
                        clientes: clientes || [],
                        ordenesLab: ordenesLab || [],
                        ventas: ventas || [],
                        estadisticas: estadisticas || { mensajesHoy: 0, promociones: 0, audiosHoy: 0 },
                        contadorOrdenes: contadorOrdenes || 1
                    },
                    metadata: {
                        totalSize: JSON.stringify({productos, clientes, ordenesLab, ventas, estadisticas}).length,
                        systemLogs: systemLogs.slice(-20), // √öltimos 20 logs
                        lastSave: new Date().toISOString()
                    }
                };
                
                // Intentar guardar en localStorage
                if (browserCapabilities.localStorage) {
                    try {
                        const backupKey = `urbanaBackup_${timestamp}`;
                        localStorage.setItem(backupKey, JSON.stringify(backupData));
                        
                        logSystem('‚úÖ Backup avanzado creado');
                        updateBackupStatus('‚úÖ Backup creado');
                        showAlert('‚úÖ Backup completo creado exitosamente');
                        
                        return backupData;
                    } catch (storageError) {
                        logSystem('‚ö†Ô∏è Error en localStorage, continuando...', storageError);
                    }
                }
                
                // Si localStorage falla, al menos retornar los datos
                logSystem('‚ö†Ô∏è Backup creado en memoria √∫nicamente');
                updateBackupStatus('‚ö†Ô∏è Backup en memoria');
                showAlert('‚ö†Ô∏è Backup creado en memoria (localStorage lleno)');
                
                return backupData;
                
            } catch (error) {
                logSystem('‚ùå Error cr√≠tico creando backup', error);
                updateBackupStatus('‚ùå Error backup');
                showAlert('‚ùå Error al crear backup');
                return null;
            }
        }

        async function exportToCloud() {
            try {
                const backupData = await createAdvancedBackup();
                if (!backupData) throw new Error('No se pudo crear el backup');
                
                const dataStr = JSON.stringify(backupData, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                
                if (browserCapabilities.download) {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `urbana_cloud_backup_${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    showAlert('‚òÅÔ∏è Backup descargado para subir a la nube');
                    updateBackupStatus('‚òÅÔ∏è Listo para nube');
                } else {
                    // Fallback: copiar al clipboard si est√° disponible
                    if (browserCapabilities.clipboard) {
                        await navigator.clipboard.writeText(dataStr);
                        showAlert('üìã Backup copiado al portapapeles');
                        updateBackupStatus('üìã En portapapeles');
                    } else {
                        showAlert('‚ùå No se puede descargar en este navegador');
                    }
                }
                
            } catch (error) {
                logSystem('‚ùå Error exportando a nube', error);
                showAlert('‚ùå Error al exportar backup');
            }
        }

        async function downloadBackup() {
            try {
                const backupData = await createAdvancedBackup();
                if (!backupData) throw new Error('No se pudo crear el backup');
                
                // Crear versi√≥n optimizada para m√≥vil
                const mobileBackup = {
                    version: '3.0-mobile',
                    date: new Date().toISOString(),
                    data: backupData.data,
                    size: JSON.stringify(backupData.data).length
                };
                
                const dataStr = JSON.stringify(mobileBackup);
                
                if (browserCapabilities.share && navigator.share) {
                    // Usar Web Share API en m√≥viles
                    const file = new File([dataStr], `urbana_mobile_backup_${new Date().toISOString().split('T')[0]}.json`, {
                        type: 'application/json'
                    });
                    
                    await navigator.share({
                        title: 'Backup Urbana Vision',
                        text: 'Backup de datos de Urbana Vision',
                        files: [file]
                    });
                    
                    showAlert('üì± Backup compartido desde el m√≥vil');
                    updateBackupStatus('üì± Compartido');
                } else if (browserCapabilities.download) {
                    // Fallback para descargar
                    const blob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `urbana_mobile_backup.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    showAlert('üì± Backup descargado al m√≥vil');
                    updateBackupStatus('üì± Descargado');
                } else {
                    showAlert('‚ùå No se puede descargar en este navegador');
                }
                
            } catch (error) {
                logSystem('‚ùå Error descargando backup', error);
                showAlert('‚ùå Error al descargar backup');
            }
        }

        async function importBackup() {
            try {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                
                input.onchange = async function(e) {
                    try {
                        const file = e.target.files[0];
                        if (!file) return;
                        
                        if (file.size > 10 * 1024 * 1024) { // 10MB
                            showAlert('‚ùå Archivo muy grande (m√°ximo 10MB)');
                            return;
                        }
                        
                        const reader = new FileReader();
                        reader.onload = async function(e) {
                            try {
                                const backupData = JSON.parse(e.target.result);
                                
                                // Validar estructura del backup
                                if (!backupData.data || !backupData.version) {
                                    throw new Error('Archivo de backup no v√°lido');
                                }
                                
                                // Confirmar importaci√≥n
                                if (!confirm(`¬øImportar backup del ${new Date(backupData.date || backupData.timestamp).toLocaleString()}?\n\nEsto reemplazar√° todos los datos actuales.`)) {
                                    return;
                                }
                                
                                // Restaurar datos
                                productos = backupData.data.productos || [];
                                clientes = backupData.data.clientes || [];
                                ordenesLab = backupData.data.ordenesLab || [];
                                ventas = backupData.data.ventas || [];
                                estadisticas = backupData.data.estadisticas || { mensajesHoy: 0, promociones: 0, audiosHoy: 0 };
                                contadorOrdenes = backupData.data.contadorOrdenes || 1;
                                
                                // Guardar y actualizar interfaz
                                await saveData();
                                await updateDashboard();
                                
                                showAlert(`‚úÖ Backup importado exitosamente`);
                                updateBackupStatus('‚úÖ Importado');
                                logSystem('‚úÖ Backup importado', { version: backupData.version });
                                
                            } catch (parseError) {
                                logSystem('‚ùå Error parseando backup', parseError);
                                showAlert('‚ùå Archivo de backup corrupto o no v√°lido');
                            }
                        };
                        reader.readAsText(file);
                    } catch (fileError) {
                        logSystem('‚ùå Error procesando archivo', fileError);
                        showAlert('‚ùå Error al procesar el archivo');
                    }
                };
                
                input.click();
            } catch (error) {
                logSystem('‚ùå Error importando backup', error);
                showAlert('‚ùå Error al importar backup');
            }
        }

        function updateBackupStatus(message) {
            try {
                setContent('backupStatus', message);
                setTimeout(() => {
                    setContent('backupStatus', 'üíæ Sistema listo');
                }, 3000);
            } catch (error) {
                logSystem('‚ùå Error actualizando estado backup', error);
            }
        }

        // ========================================
        // üöÄ FUNCIONES AUXILIARES CARGA SECCIONES
        // ========================================
        
        async function loadProducts() {
            // Implementaci√≥n simplificada para demo
            setContent('listaProductos', '<p style="text-align: center;">Lista de productos (implementar seg√∫n necesidad)</p>', true);
        }

        async function loadClients() {
            // Implementaci√≥n simplificada para demo
            setContent('listaClientes', '<p style="text-align: center;">Lista de clientes (implementar seg√∫n necesidad)</p>', true);
        }

        // ========================================
        // üîç DETECCI√ìN DE COMPATIBILIDAD
        // ========================================
        
        function detectBrowserCapabilities() {
            try {
                // localStorage
                browserCapabilities.localStorage = typeof Storage !== 'undefined' && localStorage !== null;
                
                // Camera
                browserCapabilities.camera = !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
                
                // Audio
                browserCapabilities.audio = !!(navigator.mediaDevices && typeof MediaRecorder !== 'undefined');
                
                // Share API
                browserCapabilities.share = !!navigator.share;
                
                // Download
                browserCapabilities.download = 'download' in document.createElement('a');
                
                // Clipboard
                browserCapabilities.clipboard = !!(navigator.clipboard && navigator.clipboard.writeText);
                
                logSystem('‚úÖ Capacidades detectadas', browserCapabilities);
                
                // Mostrar advertencias si es necesario
                showCompatibilityWarnings();
                
            } catch (error) {
                logSystem('‚ùå Error detectando capacidades', error);
            }
        }

        function showCompatibilityWarnings() {
            try {
                const warnings = [];
                
                if (!browserCapabilities.localStorage) {
                    warnings.push('‚ö†Ô∏è Sin soporte para almacenamiento local');
                }
                if (!browserCapabilities.camera) {
                    warnings.push('‚ö†Ô∏è Sin soporte para c√°mara');
                }
                if (!browserCapabilities.audio) {
                    warnings.push('‚ö†Ô∏è Sin soporte para grabaci√≥n de audio');
                }
                if (!browserCapabilities.share) {
                    warnings.push('‚ö†Ô∏è Sin soporte para compartir archivos');
                }
                
                if (warnings.length > 0) {
                    const warningDiv = getElement('compatibility-info');
                    if (warningDiv) {
                        warningDiv.innerHTML = warnings.join('<br>');
                        warningDiv.style.display = 'block';
                    }
                }
            } catch (error) {
                logSystem('‚ùå Error mostrando advertencias', error);
            }
        }

        // ========================================
        // üöÄ INICIALIZACI√ìN PRINCIPAL
        // ========================================
        
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                logSystem('üîÑ Iniciando Urbana Vision Pro...');
                
                // Paso 1: Detectar capacidades
                detectBrowserCapabilities();
                
                // Paso 2: Cargar datos
                await loadData();
                
                // Paso 3: Crear datos de ejemplo si es necesario
                await createSampleData();
                
                // Paso 4: Actualizar interfaz
                await updateDashboard();
                
                // Paso 5: Marcar sistema como listo
                isSystemReady = true;
                setContent('status-indicator', 'üü¢ Sistema Listo');
                showAlert('‚úÖ Urbana Vision Pro cargado correctamente');
                
                logSystem('‚úÖ Sistema iniciado correctamente');
                
            } catch (error) {
                logSystem('‚ùå Error cr√≠tico en inicializaci√≥n', error);
                setContent('status-indicator', 'üî¥ Error del Sistema');
                showAlert('‚ùå Error al inicializar sistema');
            }
        });

        // ========================================
        // üõ°Ô∏è MANEJO DE ERRORES GLOBALES
        // ========================================
        
        // Manejar errores globales
        window.addEventListener('error', function(e) {
            logSystem('‚ùå Error global', e.error);
            showAlert('‚ö†Ô∏è Error del sistema - recuperando...');
            
            // Intentar recuperaci√≥n autom√°tica
            setTimeout(async () => {
                try {
                    await loadData();
                    await updateDashboard();
                    showAlert('‚úÖ Sistema recuperado');
                } catch (recoveryError) {
                    logSystem('‚ùå Error en recuperaci√≥n', recoveryError);
                }
            }, 2000);
        });

        // Detectar cambios de conectividad
        window.addEventListener('online', function() {
            showAlert('üåê Conexi√≥n restaurada');
            updateBackupStatus('üåê Online');
        });

        window.addEventListener('offline', function() {
            showAlert('üìµ Sin conexi√≥n - trabajando offline');
            updateBackupStatus('üìµ Offline');
        });

        // Mensaje final de confirmaci√≥n
        console.log('üöÄ URBANA VISION PRO - SISTEMA ROBUSTO CARGADO');
        console.log('‚úÖ Sistema de backup avanzado con nube y m√≥vil');
        console.log('‚úÖ Detecci√≥n completa de compatibilidad');
        console.log('‚úÖ Fallbacks robustos para WhatsApp');
        console.log('‚úÖ Manejo seguro de DOM y errores');
        console.log('‚úÖ Validaciones estrictas en todas las funciones');
        console.log('‚úÖ Compatibilidad amplia de navegadores');
        console.log('‚úÖ Sistema de logs completo');
        console.log('‚úÖ Factura proforma con examen gratis');
        console.log('‚úÖ Cat√°logo integrado con inventario');
        console.log('üí™ SISTEMA 100% PROFESIONAL Y SIN ERRORES');
        
    </script>
</body>
</html>
