<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lab Security Shield | Control Anti-Robos</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', system-ui, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 25%, #0f3460 50%, #16213e 75%, #1a1a2e 100%);
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* Security Background Animation */
        .security-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: 
                radial-gradient(circle at 25% 25%, rgba(255, 0, 0, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 75% 75%, rgba(255, 165, 0, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(0, 255, 0, 0.05) 0%, transparent 50%);
            animation: securityPulse 8s ease-in-out infinite;
        }
        
        @keyframes securityPulse {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.1); }
        }
        
        /* Header */
        .header {
            background: rgba(0,0,0,0.9);
            backdrop-filter: blur(20px);
            padding: 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 2px solid #ff6b6b;
            box-shadow: 0 4px 20px rgba(255, 107, 107, 0.3);
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .logo {
            font-size: 28px;
            font-weight: 900;
            background: linear-gradient(45deg, #ff6b6b, #ffa500);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .optica-selector {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .optica-btn {
            padding: 12px 24px;
            border: 2px solid rgba(255,107,107,0.2);
            border-radius: 25px;
            background: rgba(255,107,107,0.1);
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            white-space: nowrap;
        }
        
        .optica-btn.active {
            background: linear-gradient(45deg, #ff6b6b, #ffa500);
            border-color: transparent;
            transform: scale(1.05);
        }
        
        .optica-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(255,107,107,0.3);
        }
        
        .security-status {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 15px 25px;
            background: rgba(255, 107, 107, 0.1);
            border: 2px solid #ff6b6b;
            border-radius: 25px;
        }
        
        .status-indicator {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: #00ff00;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; box-shadow: 0 0 10px #00ff00; }
            50% { opacity: 0.5; box-shadow: 0 0 20px #00ff00; }
        }
        
        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 20px;
        }
        
        /* Grid Layout */
        .security-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        /* Security Cards */
        .security-card {
            background: rgba(255,255,255,0.03);
            backdrop-filter: blur(15px);
            border: 2px solid rgba(255,107,107,0.2);
            border-radius: 20px;
            padding: 25px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .security-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #ff6b6b, #ffa500, #ff6b6b);
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .security-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 25px 60px rgba(255, 107, 107, 0.3);
            border-color: #ff6b6b;
        }
        
        .security-card:hover::before {
            opacity: 1;
        }
        
        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .card-icon {
            font-size: 32px;
            margin-right: 15px;
            padding: 15px;
            border-radius: 15px;
            background: linear-gradient(45deg, rgba(255,107,107,0.2), rgba(255,165,0,0.2));
        }
        
        .card-title {
            font-size: 24px;
            font-weight: 700;
            margin: 0;
        }
        
        .card-subtitle {
            color: rgba(255,255,255,0.7);
            font-size: 14px;
            margin-top: 5px;
        }
        
        /* Alert Levels */
        .alert-low { border-left: 4px solid #00ff00; background: rgba(0, 255, 0, 0.05); }
        .alert-medium { border-left: 4px solid #ffa500; background: rgba(255, 165, 0, 0.05); }
        .alert-high { border-left: 4px solid #ff6b6b; background: rgba(255, 107, 107, 0.05); }
        .alert-critical { 
            border-left: 4px solid #ff0000; 
            background: rgba(255, 0, 0, 0.1);
            animation: alertPulse 1s infinite;
        }
        
        @keyframes alertPulse {
            0%, 100% { box-shadow: 0 0 10px rgba(255, 0, 0, 0.3); }
            50% { box-shadow: 0 0 25px rgba(255, 0, 0, 0.6); }
        }
        
        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 15px 25px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            margin: 8px;
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn:hover::before {
            left: 100%;
        }
        
        .btn-security {
            background: linear-gradient(45deg, #ff6b6b, #ffa500);
            color: white;
        }
        
        .btn-alert {
            background: linear-gradient(45deg, #ff4757, #ff3838);
            color: white;
        }
        
        .btn-safe {
            background: linear-gradient(45deg, #2ed573, #7bed9f);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(45deg, #ffa502, #ff6348);
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.3);
        }
        
        /* Order Tracking */
        .order-tracker {
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.1), rgba(255, 165, 0, 0.1));
            border: 2px solid rgba(255, 107, 107, 0.3);
        }
        
        .order-timeline {
            position: relative;
            padding: 20px 0;
        }
        
        .timeline-item {
            display: flex;
            align-items: center;
            margin: 15px 0;
            position: relative;
        }
        
        .timeline-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 20px;
            font-weight: bold;
            z-index: 2;
            font-size: 16px;
        }
        
        .timeline-completed { background: #2ed573; color: white; }
        .timeline-active { 
            background: #ffa500; 
            color: white; 
            animation: pulse 2s infinite;
        }
        .timeline-pending { background: #6c757d; color: white; }
        .timeline-alert { 
            background: #ff4757; 
            color: white; 
            animation: alertPulse 1s infinite;
        }
        
        .timeline-content {
            flex: 1;
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 10px;
        }
        
        .timeline-title {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .timeline-time {
            font-size: 12px;
            opacity: 0.7;
        }
        
        /* Quality Control */
        .quality-checklist {
            background: rgba(0,0,0,0.3);
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
        }
        
        .checklist-item {
            display: flex;
            align-items: center;
            margin: 10px 0;
            padding: 10px;
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .checklist-item:hover {
            background: rgba(255,255,255,0.05);
        }
        
        .checklist-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid #6c757d;
            border-radius: 4px;
            margin-right: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .checklist-checkbox.checked {
            background: #2ed573;
            border-color: #2ed573;
        }
        
        .checklist-checkbox.checked::after {
            content: '‚úì';
            color: white;
            font-weight: bold;
        }
        
        .checklist-text {
            flex: 1;
        }
        
        /* Anomaly Detection */
        .anomaly-detector {
            background: linear-gradient(135deg, rgba(255, 0, 0, 0.1), rgba(255, 69, 0, 0.1));
            border: 2px solid rgba(255, 0, 0, 0.3);
        }
        
        .anomaly-item {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid;
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 15px;
        }
        
        .anomaly-low { border-left-color: #ffa500; }
        .anomaly-medium { border-left-color: #ff6b6b; }
        .anomaly-high { 
            border-left-color: #ff0000; 
            animation: alertPulse 1s infinite;
        }
        
        .anomaly-content {
            flex: 1;
        }
        
        .anomaly-title {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .anomaly-description {
            font-size: 14px;
            opacity: 0.8;
        }
        
        .anomaly-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        /* Metrics */
        .security-metric {
            text-align: center;
            padding: 20px;
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            margin: 10px 0;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .metric-value {
            font-size: 36px;
            font-weight: 900;
            margin-bottom: 5px;
        }
        
        .metric-safe { color: #2ed573; }
        .metric-warning { color: #ffa500; }
        .metric-danger { color: #ff4757; }
        
        .metric-label {
            font-size: 14px;
            opacity: 0.8;
        }
        
        /* Live Camera Feed */
        .camera-feed {
            background: #000;
            border-radius: 15px;
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 20px 0;
            border: 2px solid #ff6b6b;
            position: relative;
            overflow: hidden;
        }
        
        .camera-feed::before {
            content: 'üî¥ LIVE';
            position: absolute;
            top: 10px;
            left: 10px;
            background: #ff0000;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            z-index: 2;
            animation: pulse 2s infinite;
        }
        
        .camera-placeholder {
            text-align: center;
            color: #6c757d;
        }
        
        /* Input Styles */
        .input, .textarea, .select {
            width: 100%;
            padding: 15px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 12px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 16px;
            margin: 10px 0;
            transition: all 0.3s;
        }
        
        .input::placeholder, .textarea::placeholder {
            color: rgba(255,255,255,0.5);
        }
        
        .input:focus, .textarea:focus, .select:focus {
            outline: none;
            border-color: #ff6b6b;
            box-shadow: 0 0 20px rgba(255, 107, 107, 0.3);
        }
        
        .textarea {
            min-height: 120px;
            resize: vertical;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            backdrop-filter: blur(10px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border: 2px solid #ff6b6b;
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }
        
        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }
        
        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(45deg, #ff6b6b, #ffa500);
            color: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 3000;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s;
            max-width: 400px;
        }
        
        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }
        
        .notification.error {
            background: linear-gradient(45deg, #ff4757, #ff3838);
        }
        
        .notification.success {
            background: linear-gradient(45deg, #2ed573, #7bed9f);
        }
        
        .notification.warning {
            background: linear-gradient(45deg, #ffa502, #ff6348);
        }
        
        .notification.info {
            background: linear-gradient(45deg, #4facfe, #00f2fe);
        }
        
        /* Emergency Button */
        .emergency-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: linear-gradient(45deg, #ff0000, #ff4757);
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(255, 0, 0, 0.3);
            transition: all 0.3s;
            z-index: 1000;
            animation: emergencyPulse 3s infinite;
        }
        
        @keyframes emergencyPulse {
            0%, 100% { transform: scale(1); box-shadow: 0 10px 30px rgba(255, 0, 0, 0.3); }
            50% { transform: scale(1.1); box-shadow: 0 15px 40px rgba(255, 0, 0, 0.5); }
        }
        
        .emergency-btn:hover {
            transform: scale(1.15) rotate(15deg);
            box-shadow: 0 20px 50px rgba(255, 0, 0, 0.6);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .security-grid {
                grid-template-columns: 1fr;
            }
            
            .header-content {
                flex-direction: column;
                gap: 20px;
            }
            
            .timeline-item {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .timeline-icon {
                margin-right: 0;
                margin-bottom: 10px;
            }
            
            .anomaly-item {
                flex-direction: column;
            }
            
            .anomaly-actions {
                margin-top: 15px;
                justify-content: flex-start;
            }
        }
        
        /* Real-time updates animation */
        @keyframes dataUpdate {
            0% { opacity: 1; }
            50% { opacity: 0.5; background: rgba(255, 107, 107, 0.1); }
            100% { opacity: 1; }
        }
        
        .updating {
            animation: dataUpdate 1s ease-in-out;
        }
    </style>
</head>
<body>
    <div class="security-bg"></div>
    
    <header class="header">
        <div class="header-content">
            <div class="logo">
                üõ°Ô∏è Lab Security Shield
                <div style="font-size: 16px; opacity: 0.8;">Sistema Anti-Robos Inteligente</div>
            </div>
            <div class="optica-selector">
                <button class="optica-btn active" onclick="selectOptica('urbana')" data-phone="8097135307">
                    üè¢ Urbana Vision
                </button>
                <button class="optica-btn" onclick="selectOptica('nvision')" data-phone="8497972424">
                    üëì √ìptica Nvision
                </button>
            </div>
            <div class="security-status">
                <div class="status-indicator"></div>
                <div>
                    <div style="font-weight: bold;" id="systemStatus">Sistema Activo</div>
                    <div style="font-size: 12px; opacity: 0.8;">Monitoreo 24/7</div>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Security Overview -->
        <div class="security-card alert-low">
            <div class="card-header">
                <div class="card-icon">üõ°Ô∏è</div>
                <div>
                    <h2 class="card-title">Estado de Seguridad</h2>
                    <p class="card-subtitle">Monitoreo en tiempo real</p>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                <div class="security-metric">
                    <div class="metric-value metric-safe" id="ordersSecure">47</div>
                    <div class="metric-label">√ìrdenes Seguras</div>
                </div>
                <div class="security-metric">
                    <div class="metric-value metric-warning" id="ordersRisk">3</div>
                    <div class="metric-label">En Riesgo</div>
                </div>
                <div class="security-metric">
                    <div class="metric-value metric-danger" id="anomalies">1</div>
                    <div class="metric-label">Anomal√≠as</div>
                </div>
                <div class="security-metric">
                    <div class="metric-value metric-safe" id="uptime">99.8%</div>
                    <div class="metric-label">Uptime</div>
                </div>
            </div>
            
            <div style="margin-top: 20px; text-align: center;">
                <button class="btn btn-security" onclick="runFullScan()">
                    üîç Escaneo Completo
                </button>
                <button class="btn btn-safe" onclick="generateSecurityReport()">
                    üìä Reporte de Seguridad
                </button>
            </div>
        </div>

        <div class="security-grid">
            <!-- Order Tracking System -->
            <div class="security-card order-tracker">
                <div class="card-header">
                    <div class="card-icon">üìã</div>
                    <div>
                        <h2 class="card-title">Tracking de √ìrdenes</h2>
                        <p class="card-subtitle">Seguimiento completo anti-p√©rdidas</p>
                    </div>
                </div>
                
                <div class="order-timeline">
                    <div class="timeline-item">
                        <div class="timeline-icon timeline-completed">1</div>
                        <div class="timeline-content">
                            <div class="timeline-title">Orden Recibida</div>
                            <div class="timeline-time">LAB-2025-001 - Verificada ‚úÖ</div>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-icon timeline-completed">2</div>
                        <div class="timeline-content">
                            <div class="timeline-title">Enviada al Laboratorio</div>
                            <div class="timeline-time">Timestamp: 14:30 - GPS: Activo</div>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-icon timeline-active">3</div>
                        <div class="timeline-content">
                            <div class="timeline-title">En Producci√≥n</div>
                            <div class="timeline-time">Status: Monitoreando üü°</div>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-icon timeline-pending">4</div>
                        <div class="timeline-content">
                            <div class="timeline-title">Control de Calidad</div>
                            <div class="timeline-time">Pendiente</div>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-icon timeline-alert">‚ö†Ô∏è</div>
                        <div class="timeline-content">
                            <div class="timeline-title">Orden LAB-2025-003</div>
                            <div class="timeline-time">‚ö†Ô∏è Retraso inusual detectado</div>
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                    <button class="btn btn-security" onclick="viewAllOrders()">
                        üëÅÔ∏è Ver Todas las √ìrdenes
                    </button>
                    <button class="btn btn-alert" onclick="checkAnomalies()">
                        üö® Verificar Anomal√≠as
                    </button>
                    <button class="btn btn-safe" onclick="addNewOrder()">
                        ‚ûï Nueva Orden
                    </button>
                </div>
            </div>

            <!-- Quality Control System -->
            <div class="security-card">
                <div class="card-header">
                    <div class="card-icon">‚úÖ</div>
                    <div>
                        <h2 class="card-title">Control de Calidad</h2>
                        <p class="card-subtitle">Prevenci√≥n de confecciones malas</p>
                    </div>
                </div>
                
                <div class="quality-checklist">
                    <h4 style="margin-bottom: 15px;">üìã Checklist de Calidad (LAB-2025-001):</h4>
                    
                    <div class="checklist-item">
                        <div class="checklist-checkbox checked" onclick="toggleCheck(this)"></div>
                        <div class="checklist-text">Graduaci√≥n correcta (OD/OI verificada)</div>
                    </div>
                    <div class="checklist-item">
                        <div class="checklist-checkbox checked" onclick="toggleCheck(this)"></div>
                        <div class="checklist-text">Centrado de lentes perfecto</div>
                    </div>
                    <div class="checklist-item">
                        <div class="checklist-checkbox checked" onclick="toggleCheck(this)"></div>
                        <div class="checklist-text">Distancia pupilar exacta</div>
                    </div>
                    <div class="checklist-item">
                        <div class="checklist-checkbox" onclick="toggleCheck(this)"></div>
                        <div class="checklist-text">Tratamiento anti-reflejo aplicado</div>
                    </div>
                    <div class="checklist-item">
                        <div class="checklist-checkbox" onclick="toggleCheck(this)"></div>
                        <div class="checklist-text">Acabado de monturas perfecto</div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                    <button class="btn btn-safe" onclick="approveQuality()">
                        ‚úÖ Aprobar Calidad
                    </button>
                    <button class="btn btn-alert" onclick="rejectOrder()">
                        ‚ùå Rechazar Orden
                    </button>
                    <button class="btn btn-warning" onclick="requestCorrection()">
                        üîÑ Solicitar Correcci√≥n
                    </button>
                </div>
            </div>

            <!-- Financial Security -->
            <div class="security-card">
                <div class="card-header">
                    <div class="card-icon">üí∞</div>
                    <div>
                        <h2 class="card-title">Seguridad Financiera</h2>
                        <p class="card-subtitle">Control de costos y pagos</p>
                    </div>
                </div>
                
                <div style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 15px; margin: 15px 0;">
                    <h4 style="margin-bottom: 15px;">üí∏ An√°lisis Financiero:</h4>
                    
                    <div style="display: flex; justify-content: space-between; margin: 10px 0;">
                        <span>Total en Laboratorios:</span>
                        <span style="color: #ffa500; font-weight: bold;" id="totalInLabs">RD$ 45,230</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin: 10px 0;">
                        <span>√ìrdenes sin pagar:</span>
                        <span style="color: #ff4757; font-weight: bold;" id="unpaidOrders">RD$ 12,450</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin: 10px 0;">
                        <span>Beneficio esperado:</span>
                        <span style="color: #2ed573; font-weight: bold;" id="expectedProfit">RD$ 23,890</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin: 10px 0; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.2);">
                        <span><strong>Riesgo total:</strong></span>
                        <span style="color: #ff6b6b; font-weight: bold; font-size: 18px;" id="totalRisk">RD$ 57,680</span>
                    </div>
                </div>
                
                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                    <button class="btn btn-warning" onclick="reviewFinances()">
                        üí∞ Revisar Finanzas
                    </button>
                    <button class="btn btn-alert" onclick="flagRisks()">
                        üö® Marcar Riesgos
                    </button>
                    <button class="btn btn-security" onclick="sendPaymentReminder()">
                        üì± Recordatorio Pago
                    </button>
                </div>
            </div>
        </div>

        <!-- Anomaly Detection System -->
        <div class="security-card anomaly-detector">
            <div class="card-header">
                <div class="card-icon">üïµÔ∏è</div>
                <div>
                    <h2 class="card-title">Detector de Anomal√≠as IA</h2>
                    <p class="card-subtitle">Inteligencia artificial detectando patrones</p>
                </div>
            </div>
            
            <div id="anomaliesList">
                <div class="anomaly-item anomaly-high">
                    <div class="anomaly-content">
                        <div class="anomaly-title">üö® Orden LAB-2025-003 - Tiempo excesivo</div>
                        <div class="anomaly-description">
                            Lleva 12 d√≠as en laboratorio. Tiempo normal: 3-5 d√≠as.
                            <br>√öltima actualizaci√≥n: Hace 3 d√≠as
                            <br><strong>Riesgo financiero:</strong> RD$ 3,500
                        </div>
                    </div>
                    <div class="anomaly-actions">
                        <button class="btn btn-alert" onclick="investigateAnomaly('LAB-2025-003')">üîç Investigar</button>
                        <button class="btn btn-warning" onclick="contactLab('lab3')">üìû Contactar</button>
                        <button class="btn btn-security" onclick="notifyClient('LAB-2025-003')">üì± Cliente</button>
                    </div>
                </div>
                
                <div class="anomaly-item anomaly-medium">
                    <div class="anomaly-content">
                        <div class="anomaly-title">‚ö†Ô∏è Laboratorio XYZ - Patr√≥n inusual</div>
                        <div class="anomaly-description">
                            5 √≥rdenes con retrasos esta semana. Requiere atenci√≥n.
                            <br><strong>Promedio de retraso:</strong> 7 d√≠as
                        </div>
                    </div>
                    <div class="anomaly-actions">
                        <button class="btn btn-warning" onclick="reviewLab('xyz')">üìä Revisar</button>
                        <button class="btn btn-security" onclick="setAlert('xyz')">üîî Alerta</button>
                    </div>
                </div>
                
                <div class="anomaly-item anomaly-low">
                    <div class="anomaly-content">
                        <div class="anomaly-title">üí° Sugerencia de optimizaci√≥n</div>
                        <div class="anomaly-description">
                            √ìrdenes de progresivos toman 20% m√°s tiempo. Considerar nuevo proveedor.
                        </div>
                    </div>
                    <div class="anomaly-actions">
                        <button class="btn btn-safe" onclick="viewSuggestion()">üí° Ver M√°s</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Security Dashboard -->
        <div class="security-grid">
            <!-- Camera Monitoring -->
            <div class="security-card">
                <div class="card-header">
                    <div class="card-icon">üìπ</div>
                    <div>
                        <h2 class="card-title">Monitoreo Visual</h2>
                        <p class="card-subtitle">C√°maras del laboratorio</p>
                    </div>
                </div>
                
                <div class="camera-feed">
                    <div class="camera-placeholder">
                        <div style="font-size: 64px; margin-bottom: 15px;">üìπ</div>
                        <div>C√°mara 1 - √Årea Principal</div>
                        <div style="font-size: 12px; opacity: 0.6; margin-top: 10px;">
                            Resoluci√≥n: 1080p | FPS: 30 | Status: Activa
                        </div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px;">
                    <button class="btn btn-security" onclick="switchCamera(1)">üìπ Cam 1</button>
                    <button class="btn btn-security" onclick="switchCamera(2)">üìπ Cam 2</button>
                    <button class="btn btn-security" onclick="switchCamera(3)">üìπ Cam 3</button>
                </div>
                
                <div style="margin-top: 15px;">
                    <button class="btn btn-warning" onclick="recordIncident()">üìπ Grabar Incidente</button>
                    <button class="btn btn-alert" onclick="emergencyAlert()">üö® Alerta</button>
                </div>
            </div>

            <!-- Communication Hub -->
            <div class="security-card">
                <div class="card-header">
                    <div class="card-icon">üì±</div>
                    <div>
                        <h2 class="card-title">Centro de Comunicaciones</h2>
                        <p class="card-subtitle">WhatsApp y notificaciones</p>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin: 20px 0;">
                    <button class="btn btn-safe" onclick="sendStatusUpdate()">
                        üì± Estado a Clientes
                    </button>
                    <button class="btn btn-warning" onclick="sendDelayNotification()">
                        ‚è∞ Notificar Retrasos
                    </button>
                    <button class="btn btn-security" onclick="contactAllLabs()">
                        üè≠ Contactar Labs
                    </button>
                    <button class="btn btn-alert" onclick="emergencyBroadcast()">
                        üì° Broadcast Emergencia
                    </button>
                </div>
                
                <div style="background: rgba(37, 211, 102, 0.1); padding: 15px; border-radius: 10px; margin: 15px 0;">
                    <h4 style="color: #25d366; margin-bottom: 10px;">üì± WhatsApp Activo</h4>
                    <p style="font-size: 14px; opacity: 0.8;">
                        <span id="currentOpticaPhone">809-713-5307</span> - Sistema configurado autom√°ticamente
                    </p>
                </div>
            </div>
        </div>

        <!-- Emergency Actions -->
        <div class="security-card alert-critical">
            <div class="card-header">
                <div class="card-icon">üö®</div>
                <div>
                    <h2 class="card-title">Protocolos de Emergencia</h2>
                    <p class="card-subtitle">Respuesta r√°pida ante incidentes</p>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0;">
                <button class="btn btn-alert" onclick="emergencyAlert()">
                    üö® Alerta General
                </button>
                <button class="btn btn-alert" onclick="lockdownMode()">
                    üîí Modo Bloqueo
                </button>
                <button class="btn btn-warning" onclick="contactAuthorities()">
                    üìû Autoridades
                </button>
                <button class="btn btn-security" onclick="generateIncidentReport()">
                    üìã Reporte Incidente
                </button>
            </div>
            
            <div style="background: rgba(255, 0, 0, 0.1); padding: 15px; border-radius: 10px; border: 1px solid #ff4757;">
                <h4 style="color: #ff4757; margin-bottom: 10px;">‚ö†Ô∏è Protocolo de Emergencia:</h4>
                <ol style="padding-left: 20px; line-height: 1.6;">
                    <li>Documentar el incidente inmediatamente</li>
                    <li>Activar modo bloqueo si es necesario</li>
                    <li>Contactar laboratorios afectados</li>
                    <li>Notificar a clientes si aplica</li>
                    <li>Generar reporte para seguimiento</li>
                    <li>Enviar notificaciones por WhatsApp</li>
                </ol>
            </div>
        </div>
    </div>

    <!-- Emergency Button -->
    <button class="emergency-btn" onclick="quickEmergency()" title="Emergencia R√°pida">
        üö®
    </button>

    <!-- Modal -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">‚úï</button>
            <div id="modalContent">
                <!-- Contenido din√°mico -->
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <script>
        // ========================================
        // üõ°Ô∏è VARIABLES GLOBALES DE SEGURIDAD
        // ========================================
        
        let currentOptica = 'urbana';
        let orders = [];
        let anomalies = [];
        let securityLogs = [];
        let qualityChecks = [];
        let systemLocked = false;
        
        // Configuraciones por √≥ptica
        const opticaConfig = {
            urbana: {
                nombre: 'Urbana Vision',
                telefono: '809-713-5307',
                whatsapp: '18097135307',
                web: 'urbanavision.com',
                colores: ['#ff6b6b', '#ffa500']
            },
            nvision: {
                nombre: '√ìptica Nvision',
                telefono: '849-797-2424',
                whatsapp: '18497972424',
                web: 'opticanvision.com',
                colores: ['#ff6b6b', '#ffa500']
            }
        };
        
        let financialData = {
            totalInLabs: 45230,
            unpaidOrders: 12450,
            expectedProfit: 23890,
            totalRisk: 57680
        };
        
        // Datos de ejemplo de √≥rdenes
        const sampleOrders = [
            {
                id: 'LAB-2025-001',
                client: 'Mar√≠a Gonz√°lez',
                phone: '809-555-0001',
                status: 'en_produccion',
                startDate: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000),
                expectedDate: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000),
                laboratory: 'Lab Central',
                cost: 2500,
                price: 4000,
                risk: 'low',
                prescription: 'OD: -2.50 SPH / OI: -2.75 SPH',
                notes: 'Cliente regular, urgente'
            },
            {
                id: 'LAB-2025-002',
                client: 'Juan P√©rez',
                phone: '809-555-0002',
                status: 'control_calidad',
                startDate: new Date(Date.now() - 4 * 24 * 60 * 60 * 1000),
                expectedDate: new Date(Date.now() + 1 * 24 * 60 * 60 * 1000),
                laboratory: 'Lab Express',
                cost: 1800,
                price: 3200,
                risk: 'low',
                prescription: 'OD: -1.25 SPH / OI: -1.50 SPH',
                notes: 'Primera vez, seguimiento especial'
            },
            {
                id: 'LAB-2025-003',
                client: 'Ana Rodr√≠guez',
                phone: '809-555-0003',
                status: 'retraso',
                startDate: new Date(Date.now() - 12 * 24 * 60 * 60 * 1000),
                expectedDate: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000),
                laboratory: 'Lab XYZ',
                cost: 3200,
                price: 5500,
                risk: 'high',
                prescription: 'Progresivos: ADD +2.25',
                notes: 'Caso complejo, requiere atenci√≥n'
            }
        ];

        // ========================================
        // üöÄ INICIALIZACI√ìN DEL SISTEMA
        // ========================================
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üõ°Ô∏è Lab Security Shield iniciando...');
            initializeSystem();
            loadSampleData();
            startMonitoring();
            showNotification('üõ°Ô∏è Sistema de seguridad activado', 'success');
        });

        function initializeSystem() {
            try {
                // Cargar datos guardados
                orders = JSON.parse(localStorage.getItem('labSecurityOrders') || JSON.stringify(sampleOrders));
                anomalies = JSON.parse(localStorage.getItem('labSecurityAnomalies') || '[]');
                securityLogs = JSON.parse(localStorage.getItem('labSecurityLogs') || '[]');
                qualityChecks = JSON.parse(localStorage.getItem('labQualityChecks') || '[]');
                
                updateSecurityMetrics();
                detectAnomalies();
                updateCurrentOpticaPhone();
                
                console.log('‚úÖ Sistema inicializado correctamente');
            } catch (error) {
                console.error('‚ùå Error inicializando sistema:', error);
                showNotification('‚ö†Ô∏è Error al inicializar sistema', 'error');
            }
        }

        function loadSampleData() {
            // Generar logs de seguridad de ejemplo
            if (securityLogs.length === 0) {
                securityLogs.push(
                    {
                        timestamp: new Date(),
                        type: 'system_start',
                        message: 'Sistema de seguridad iniciado',
                        severity: 'info'
                    },
                    {
                        timestamp: new Date(Date.now() - 60000),
                        type: 'anomaly_detected',
                        message: 'Retraso detectado en LAB-2025-003',
                        severity: 'warning'
                    },
                    {
                        timestamp: new Date(Date.now() - 300000),
                        type: 'quality_check',
                        message: 'Control de calidad completado para LAB-2025-002',
                        severity: 'success'
                    }
                );
                saveSecurityData();
            }
        }

        function startMonitoring() {
            // Monitoreo en tiempo real cada 30 segundos
            setInterval(() => {
                updateSecurityMetrics();
                detectAnomalies();
                checkOrderStatus();
                updateFinancialData();
            }, 30000);
            
            console.log('üîÑ Monitoreo en tiempo real iniciado');
        }

        function saveSecurityData() {
            try {
                localStorage.setItem('labSecurityOrders', JSON.stringify(orders));
                localStorage.setItem('labSecurityAnomalies', JSON.stringify(anomalies));
                localStorage.setItem('labSecurityLogs', JSON.stringify(securityLogs));
                localStorage.setItem('labQualityChecks', JSON.stringify(qualityChecks));
                
                console.log('üíæ Datos de seguridad guardados');
            } catch (error) {
                console.error('‚ùå Error guardando datos:', error);
            }
        }

        function selectOptica(optica) {
            currentOptica = optica;
            
            // Actualizar botones
            document.querySelectorAll('.optica-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            updateCurrentOpticaPhone();
            const config = opticaConfig[optica];
            showNotification(`‚úÖ Sistema configurado para ${config.nombre}`, 'success');
        }

        function updateCurrentOpticaPhone() {
            const config = opticaConfig[currentOptica];
            const phoneElement = document.getElementById('currentOpticaPhone');
            if (phoneElement) {
                phoneElement.textContent = config.telefono;
            }
        }

        // ========================================
        // üìä M√âTRICAS DE SEGURIDAD
        // ========================================
        
        function updateSecurityMetrics() {
            try {
                const secureOrders = orders.filter(o => o.risk === 'low').length;
                const riskOrders = orders.filter(o => o.risk === 'medium' || o.risk === 'high').length;
                const anomalyCount = anomalies.filter(a => !a.resolved).length;
                const uptime = systemLocked ? 95.2 : 99.8;
                
                // Actualizar UI con animaci√≥n
                const elements = [
                    { id: 'ordersSecure', value: secureOrders },
                    { id: 'ordersRisk', value: riskOrders },
                    { id: 'anomalies', value: anomalyCount },
                    { id: 'uptime', value: uptime + '%' }
                ];
                
                elements.forEach(el => {
                    const element = document.getElementById(el.id);
                    if (element) {
                        element.classList.add('updating');
                        setTimeout(() => {
                            element.textContent = el.value;
                            element.classList.remove('updating');
                        }, 500);
                    }
                });
                
                console.log('üìä M√©tricas actualizadas');
            } catch (error) {
                console.error('‚ùå Error actualizando m√©tricas:', error);
            }
        }

        function updateFinancialData() {
            try {
                // Simular fluctuaciones financieras
                const variance = 0.02; // 2% de variaci√≥n
                
                financialData.totalInLabs += Math.floor((Math.random() - 0.5) * financialData.totalInLabs * variance);
                financialData.unpaidOrders += Math.floor((Math.random() - 0.5) * financialData.unpaidOrders * variance);
                financialData.expectedProfit += Math.floor((Math.random() - 0.5) * financialData.expectedProfit * variance);
                financialData.totalRisk = financialData.totalInLabs + financialData.unpaidOrders;
                
                // Actualizar UI
                document.getElementById('totalInLabs').textContent = `RD$ ${financialData.totalInLabs.toLocaleString()}`;
                document.getElementById('unpaidOrders').textContent = `RD$ ${financialData.unpaidOrders.toLocaleString()}`;
                document.getElementById('expectedProfit').textContent = `RD$ ${financialData.expectedProfit.toLocaleString()}`;
                document.getElementById('totalRisk').textContent = `RD$ ${financialData.totalRisk.toLocaleString()}`;
                
            } catch (error) {
                console.error('‚ùå Error actualizando datos financieros:', error);
            }
        }

        function detectAnomalies() {
            try {
                // Limpiar anomal√≠as resueltas
                anomalies = anomalies.filter(a => !a.resolved);
                
                orders.forEach(order => {
                    const now = new Date();
                    const daysSinceStart = Math.floor((now - new Date(order.startDate)) / (1000 * 60 * 60 * 24));
                    
                    // Detectar retrasos
                    if (daysSinceStart > 7 && order.status !== 'completado') {
                        const existingAnomaly = anomalies.find(a => a.orderId === order.id && a.type === 'delay');
                        if (!existingAnomaly) {
                            anomalies.push({
                                id: Date.now() + Math.random(),
                                type: 'delay',
                                orderId: order.id,
                                message: `Orden ${order.id} lleva ${daysSinceStart} d√≠as sin completar`,
                                severity: daysSinceStart > 10 ? 'high' : 'medium',
                                timestamp: new Date(),
                                resolved: false
                            });
                        }
                    }
                    
                    // Detectar costos inusuales
                    if (order.cost > 3000) {
                        const existingAnomaly = anomalies.find(a => a.orderId === order.id && a.type === 'cost');
                        if (!existingAnomaly) {
                            anomalies.push({
                                id: Date.now() + Math.random() + 1,
                                type: 'cost',
                                orderId: order.id,
                                message: `Costo inusualmente alto en ${order.id}: RD$ ${order.cost.toLocaleString()}`,
                                severity: 'medium',
                                timestamp: new Date(),
                                resolved: false
                            });
                        }
                    }
                });
                
                saveSecurityData();
                console.log(`üïµÔ∏è ${anomalies.filter(a => !a.resolved).length} anomal√≠as activas`);
            } catch (error) {
                console.error('‚ùå Error detectando anomal√≠as:', error);
            }
        }

        function checkOrderStatus() {
            orders.forEach(order => {
                const now = new Date();
                const expectedDate = new Date(order.expectedDate);
                
                if (now > expectedDate && order.status !== 'completado') {
                    order.risk = 'high';
                    
                    // Log del evento
                    securityLogs.push({
                        timestamp: new Date(),
                        type: 'order_overdue',
                        message: `Orden ${order.id} vencida`,
                        severity: 'warning',
                        orderId: order.id
                    });
                }
            });
            
            saveSecurityData();
        }

        // ========================================
        // üìã GESTI√ìN DE √ìRDENES
        // ========================================
        
        function viewAllOrders() {
            const ordersHtml = orders.map(order => {
                const status = getStatusBadge(order.status);
                const risk = getRiskBadge(order.risk);
                const daysSinceStart = Math.floor((new Date() - new Date(order.startDate)) / (1000 * 60 * 60 * 24));
                
                return `
                    <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; margin: 10px 0; border-left: 4px solid ${getRiskColor(order.risk)};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 10px;">
                            <h4>${order.id}</h4>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                ${status}
                                ${risk}
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; font-size: 14px; margin-bottom: 15px;">
                            <div><strong>Cliente:</strong> ${order.client}</div>
                            <div><strong>Tel√©fono:</strong> ${order.phone}</div>
                            <div><strong>Laboratorio:</strong> ${order.laboratory}</div>
                            <div><strong>D√≠as:</strong> ${daysSinceStart}</div>
                            <div><strong>Costo:</strong> RD$ ${order.cost.toLocaleString()}</div>
                            <div><strong>Precio:</strong> RD$ ${order.price.toLocaleString()}</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; margin: 10px 0; font-size: 13px;">
                            <strong>Graduaci√≥n:</strong> ${order.prescription}<br>
                            <strong>Notas:</strong> ${order.notes}
                        </div>
                        <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn btn-security" onclick="inspectOrder('${order.id}')">üîç Inspeccionar</button>
                            <button class="btn btn-warning" onclick="updateOrderStatus('${order.id}')">üîÑ Actualizar</button>
                            <button class="btn btn-safe" onclick="contactClient('${order.id}')">üì± Cliente</button>
                            ${order.risk === 'high' ? '<button class="btn btn-alert" onclick="escalateOrder(\''+order.id+'\')">üö® Escalar</button>' : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            openModal(`
                <h2>üìã Todas las √ìrdenes del Laboratorio</h2>
                <div style="max-height: 500px; overflow-y: auto; margin: 20px 0;">
                    ${ordersHtml}
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-security" onclick="exportOrdersReport()">üì§ Exportar Reporte</button>
                    <button class="btn btn-safe" onclick="addNewOrder()">‚ûï Nueva Orden</button>
                </div>
            `);
        }

        function addNewOrder() {
            openModal(`
                <h2>‚ûï Nueva Orden de Laboratorio</h2>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin: 20px 0;">
                    <input type="text" class="input" id="newClientName" placeholder="Nombre del cliente">
                    <input type="text" class="input" id="newClientPhone" placeholder="Tel√©fono del cliente">
                    <input type="text" class="input" id="newPrescription" placeholder="Graduaci√≥n (OD/OI)">
                    <select class="select" id="newLaboratory">
                        <option value="">Seleccionar laboratorio</option>
                        <option value="Lab Central">Lab Central</option>
                        <option value="Lab Express">Lab Express</option>
                        <option value="Lab XYZ">Lab XYZ</option>
                        <option value="Lab Premium">Lab Premium</option>
                    </select>
                    <input type="number" class="input" id="newCost" placeholder="Costo RD$">
                    <input type="number" class="input" id="newPrice" placeholder="Precio RD$">
                </div>
                
                <textarea class="textarea" id="newNotes" placeholder="Notas especiales de la orden..."></textarea>
                
                <div style="background: rgba(0,255,0,0.1); padding: 15px; border-radius: 10px; margin: 15px 0;">
                    <h4 style="color: #2ed573;">‚úÖ La orden ser√°:</h4>
                    <ul style="padding-left: 20px; margin: 10px 0;">
                        <li>Registrada autom√°ticamente en el sistema</li>
                        <li>Asignada un ID √∫nico</li>
                        <li>Monitoreada en tiempo real</li>
                        <li>Incluida en el an√°lisis de anomal√≠as</li>
                    </ul>
                </div>
                
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button class="btn btn-safe" onclick="createNewOrder()">‚úÖ Crear Orden</button>
                    <button class="btn btn-warning" onclick="closeModal()">‚ùå Cancelar</button>
                </div>
            `);
        }

        function createNewOrder() {
            const clientName = document.getElementById('newClientName').value;
            const clientPhone = document.getElementById('newClientPhone').value;
            const prescription = document.getElementById('newPrescription').value;
            const laboratory = document.getElementById('newLaboratory').value;
            const cost = parseFloat(document.getElementById('newCost').value);
            const price = parseFloat(document.getElementById('newPrice').value);
            const notes = document.getElementById('newNotes').value;
            
            // Validaciones
            if (!clientName || !clientPhone || !laboratory || !cost || !price) {
                showNotification('‚ùå Complete todos los campos obligatorios', 'error');
                return;
            }
            
            if (cost >= price) {
                showNotification('‚ùå El precio debe ser mayor al costo', 'error');
                return;
            }
            
            // Crear nueva orden
            const newOrder = {
                id: `LAB-2025-${String(orders.length + 1).padStart(3, '0')}`,
                client: clientName,
                phone: clientPhone,
                status: 'recibida',
                startDate: new Date(),
                expectedDate: new Date(Date.now() + 5 * 24 * 60 * 60 * 1000), // 5 d√≠as
                laboratory: laboratory,
                cost: cost,
                price: price,
                risk: 'low',
                prescription: prescription || 'No especificada',
                notes: notes || 'Sin notas especiales'
            };
            
            orders.push(newOrder);
            
            // Registrar evento
            securityLogs.push({
                timestamp: new Date(),
                type: 'order_created',
                message: `Nueva orden creada: ${newOrder.id} para ${clientName}`,
                severity: 'info',
                orderId: newOrder.id
            });
            
            saveSecurityData();
            updateSecurityMetrics();
            closeModal();
            
            showNotification(`‚úÖ Orden ${newOrder.id} creada exitosamente`, 'success');
        }

        function inspectOrder(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;
            
            const daysSinceStart = Math.floor((new Date() - new Date(order.startDate)) / (1000 * 60 * 60 * 24));
            const isOverdue = new Date() > new Date(order.expectedDate);
            
            openModal(`
                <h2>üîç Inspecci√≥n Detallada: ${order.id}</h2>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin: 20px 0;">
                    <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px;">
                        <h4>üë§ Cliente</h4>
                        <p><strong>Nombre:</strong> ${order.client}</p>
                        <p><strong>Tel√©fono:</strong> ${order.phone}</p>
                        <p><strong>Graduaci√≥n:</strong> ${order.prescription}</p>
                        <button class="btn btn-safe" onclick="contactClient('${order.id}')" style="margin-top: 10px;">üì± Contactar</button>
                    </div>
                    
                    <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px;">
                        <h4>üè≠ Laboratorio</h4>
                        <p><strong>Proveedor:</strong> ${order.laboratory}</p>
                        <p><strong>Estado:</strong> ${order.status}</p>
                        <p><strong>Riesgo:</strong> ${order.risk}</p>
                        <button class="btn btn-warning" onclick="contactLab('${order.laboratory}')" style="margin-top: 10px;">üìû Contactar Lab</button>
                    </div>
                    
                    <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px;">
                        <h4>üí∞ Financiero</h4>
                        <p><strong>Costo:</strong> RD$ ${order.cost.toLocaleString()}</p>
                        <p><strong>Precio:</strong> RD$ ${order.price.toLocaleString()}</p>
                        <p><strong>Beneficio:</strong> RD$ ${(order.price - order.cost).toLocaleString()}</p>
                        <p><strong>Margen:</strong> ${(((order.price - order.cost) / order.price) * 100).toFixed(1)}%</p>
                    </div>
                    
                    <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px;">
                        <h4>‚è∞ Timeline</h4>
                        <p><strong>Inicio:</strong> ${new Date(order.startDate).toLocaleDateString()}</p>
                        <p><strong>Esperada:</strong> ${new Date(order.expectedDate).toLocaleDateString()}</p>
                        <p><strong>D√≠as:</strong> ${daysSinceStart}</p>
                        ${isOverdue ? 
                            `<p style="color: #ff4757;"><strong>‚ö†Ô∏è Vencida:</strong> ${Math.floor((new Date() - new Date(order.expectedDate)) / (1000 * 60 * 60 * 24))} d√≠as</p>` : 
                            `<p style="color: #2ed573;"><strong>‚úÖ A tiempo</strong></p>`
                        }
                    </div>
                </div>
                
                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; margin: 15px 0;">
                    <h4>üìù Notas</h4>
                    <p>${order.notes}</p>
                </div>
                
                <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                    <button class="btn btn-security" onclick="trackOrder('${order.id}')">üìç Rastrear</button>
                    <button class="btn btn-warning" onclick="updateOrderStatus('${order.id}')">üîÑ Actualizar</button>
                    <button class="btn btn-alert" onclick="flagOrder('${order.id}')">üö© Marcar</button>
                    ${order.risk === 'high' ? 
                        `<button class="btn btn-alert" onclick="escalateOrder('${order.id}')">üö® Escalar</button>` : ''}
                </div>
            `);
        }

        function contactClient(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;
            
            const config = opticaConfig[currentOptica];
            const message = `Hola ${order.client}, 

Le escribimos desde ${config.nombre} para actualizar sobre su orden ${order.id}.

üìã Estado actual: ${getStatusText(order.status)}
üëì Graduaci√≥n: ${order.prescription}
üè≠ Laboratorio: ${order.laboratory}

Cualquier consulta, estamos a su disposici√≥n.

Saludos,
${config.nombre}`;
            
            try {
                const whatsappUrl = `https://wa.me/${order.phone.replace(/[^0-9]/g, '')}?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');
                
                // Registrar contacto
                securityLogs.push({
                    timestamp: new Date(),
                    type: 'client_contacted',
                    message: `Cliente ${order.client} contactado sobre orden ${order.id}`,
                    severity: 'info',
                    orderId: order.id
                });
                
                saveSecurityData();
                showNotification(`üì± Contactando a ${order.client}`, 'success');
            } catch (error) {
                showNotification('‚ùå Error al contactar cliente', 'error');
            }
        }

        function updateOrderStatus(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;
            
            openModal(`
                <h2>üîÑ Actualizar Estado: ${orderId}</h2>
                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; margin: 20px 0;">
                    <h4>üë§ ${order.client}</h4>
                    <p>Estado actual: <strong>${getStatusText(order.status)}</strong></p>
                </div>
                
                <div style="margin: 20px 0;">
                    <label style="display: block; margin-bottom: 10px;">Nuevo estado:</label>
                    <select class="select" id="newStatus">
                        <option value="recibida">üì• Recibida</option>
                        <option value="en_produccion">üîÑ En Producci√≥n</option>
                        <option value="control_calidad">‚úÖ Control de Calidad</option>
                        <option value="completado">‚úÖ Completado</option>
                        <option value="retraso">‚ö†Ô∏è Retraso</option>
                        <option value="rechazado">‚ùå Rechazado</option>
                    </select>
                </div>
                
                <textarea class="textarea" id="statusNote" placeholder="Notas sobre la actualizaci√≥n (opcional)..."></textarea>
                
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button class="btn btn-security" onclick="confirmStatusUpdate('${orderId}')">‚úÖ Actualizar</button>
                    <button class="btn btn-warning" onclick="closeModal()">‚ùå Cancelar</button>
                </div>
            `);
        }

        function confirmStatusUpdate(orderId) {
            const newStatus = document.getElementById('newStatus').value;
            const note = document.getElementById('statusNote').value;
            
            const order = orders.find(o => o.id === orderId);
            if (order) {
                const oldStatus = order.status;
                order.status = newStatus;
                order.lastUpdated = new Date().toISOString();
                
                // Ajustar nivel de riesgo basado en el estado
                if (newStatus === 'completado') {
                    order.risk = 'low';
                } else if (newStatus === 'retraso' || newStatus === 'rechazado') {
                    order.risk = 'high';
                } else {
                    order.risk = 'medium';
                }
                
                // Registrar cambio
                securityLogs.push({
                    timestamp: new Date(),
                    type: 'status_updated',
                    message: `Estado de ${orderId} cambiado de ${oldStatus} a ${newStatus}${note ? ': ' + note : ''}`,
                    severity: 'info',
                    orderId: orderId
                });
            }
            
            saveSecurityData();
            updateSecurityMetrics();
            closeModal();
            
            showNotification(`‚úÖ Estado de ${orderId} actualizado`, 'success');
        }

        function getStatusText(status) {
            const statusMap = {
                'recibida': 'Recibida',
                'en_produccion': 'En Producci√≥n',
                'control_calidad': 'Control de Calidad',
                'completado': 'Completado',
                'retraso': 'Retraso',
                'rechazado': 'Rechazado'
            };
            return statusMap[status] || status;
        }

        function getStatusBadge(status) {
            const badges = {
                'recibida': '<span style="background: #17a2b8; padding: 4px 8px; border-radius: 12px; font-size: 12px;">üì• Recibida</span>',
                'en_produccion': '<span style="background: #ffa500; padding: 4px 8px; border-radius: 12px; font-size: 12px;">üîÑ En Producci√≥n</span>',
                'control_calidad': '<span style="background: #17a2b8; padding: 4px 8px; border-radius: 12px; font-size: 12px;">‚úÖ Control Calidad</span>',
                'completado': '<span style="background: #28a745; padding: 4px 8px; border-radius: 12px; font-size: 12px;">‚úÖ Completado</span>',
                'retraso': '<span style="background: #dc3545; padding: 4px 8px; border-radius: 12px; font-size: 12px;">‚ö†Ô∏è Retraso</span>',
                'rechazado': '<span style="background: #dc3545; padding: 4px 8px; border-radius: 12px; font-size: 12px;">‚ùå Rechazado</span>'
            };
            return badges[status] || '<span style="background: #6c757d; padding: 4px 8px; border-radius: 12px; font-size: 12px;">‚ùì Desconocido</span>';
        }

        function getRiskBadge(risk) {
            const badges = {
                'low': '<span style="background: #28a745; padding: 4px 8px; border-radius: 12px; font-size: 12px;">üü¢ Bajo Riesgo</span>',
                'medium': '<span style="background: #ffc107; padding: 4px 8px; border-radius: 12px; font-size: 12px;">üü° Riesgo Medio</span>',
                'high': '<span style="background: #dc3545; padding: 4px 8px; border-radius: 12px; font-size: 12px;">üî¥ Alto Riesgo</span>'
            };
            return badges[risk] || badges.low;
        }

        function getRiskColor(risk) {
            const colors = {
                'low': '#28a745',
                'medium': '#ffc107',
                'high': '#dc3545'
            };
            return colors[risk] || colors.low;
        }

        // ========================================
        // ‚úÖ CONTROL DE CALIDAD
        // ========================================
        
        function toggleCheck(checkbox) {
            checkbox.classList.toggle('checked');
            checkQualityProgress();
        }

        function checkQualityProgress() {
            const total = document.querySelectorAll('.checklist-checkbox').length;
            const checked = document.querySelectorAll('.checklist-checkbox.checked').length;
            const progress = Math.round((checked / total) * 100);
            
            console.log(`‚úÖ Progreso de calidad: ${progress}%`);
            
            if (progress === 100) {
                showNotification('‚úÖ Control de calidad completado al 100%', 'success');
            }
        }

        function approveQuality() {
            const checkedItems = document.querySelectorAll('.checklist-checkbox.checked').length;
            const totalItems = document.querySelectorAll('.checklist-checkbox').length;
            
            if (checkedItems < totalItems) {
                showNotification('‚ö†Ô∏è Complete todos los checks de calidad primero', 'warning');
                return;
            }
            
            openModal(`
                <h2>‚úÖ Aprobar Control de Calidad</h2>
                <div style="background: rgba(0, 255, 0, 0.1); padding: 20px; border-radius: 15px; border: 2px solid #2ed573; margin: 20px 0; text-align: center;">
                    <div style="font-size: 64px; margin-bottom: 15px;">‚úÖ</div>
                    <h3>Control de Calidad: APROBADO</h3>
                    <p>Orden LAB-2025-001 cumple con todos los est√°ndares de calidad.</p>
                </div>
                
                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; margin: 15px 0;">
                    <h4>üìã Resumen de Verificaci√≥n:</h4>
                    <ul style="padding-left: 20px; margin: 10px 0;">
                        <li>‚úÖ Graduaci√≥n verificada y correcta</li>
                        <li>‚úÖ Centrado perfecto de lentes</li>
                        <li>‚úÖ Distancia pupilar exacta</li>
                        <li>‚úÖ Tratamientos aplicados correctamente</li>
                        <li>‚úÖ Acabado de monturas perfecto</li>
                    </ul>
                </div>
                
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button class="btn btn-safe" onclick="finalizeApproval()">‚úÖ Confirmar Aprobaci√≥n</button>
                    <button class="btn btn-security" onclick="closeModal()">üìã Revisar Nuevamente</button>
                </div>
            `);
        }

        function finalizeApproval() {
            // Actualizar estado de la orden
            const order = orders.find(o => o.id === 'LAB-2025-001');
            if (order) {
                order.status = 'completado';
                order.risk = 'low';
                order.qualityApproved = true;
                order.approvalDate = new Date().toISOString();
            }
            
            // Registrar en logs
            securityLogs.push({
                timestamp: new Date(),
                type: 'quality_approved',
                message: 'Control de calidad aprobado para LAB-2025-001',
                severity: 'success',
                orderId: 'LAB-2025-001'
            });
            
            saveSecurityData();
            updateSecurityMetrics();
            closeModal();
            
            showNotification('‚úÖ Orden LAB-2025-001 aprobada y lista para entrega', 'success');
        }

        function rejectOrder() {
            openModal(`
                <h2>‚ùå Rechazar Orden</h2>
                <div style="background: rgba(255, 0, 0, 0.1); padding: 20px; border-radius: 15px; border: 2px solid #ff4757; margin: 20px 0;">
                    <h3 style="color: #ff4757;">‚ö†Ô∏è RECHAZAR ORDEN LAB-2025-001</h3>
                    <p>Esta acci√≥n marcar√° la orden como rechazada y requerir√° correcci√≥n.</p>
                </div>
                
                <textarea class="textarea" id="rejectionReason" placeholder="Detalle los problemas encontrados en esta orden..."></textarea>
                
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button class="btn btn-alert" onclick="confirmRejection()">‚ùå Confirmar Rechazo</button>
                    <button class="btn btn-security" onclick="closeModal()">üîô Cancelar</button>
                </div>
            `);
        }

        function confirmRejection() {
            const reason = document.getElementById('rejectionReason').value;
            if (!reason.trim()) {
                showNotification('‚ùå Especifique la raz√≥n del rechazo', 'error');
                return;
            }
            
            // Actualizar orden
            const order = orders.find(o => o.id === 'LAB-2025-001');
            if (order) {
                order.status = 'rechazado';
                order.risk = 'high';
                order.rejectionReason = reason;
                order.rejectionDate = new Date().toISOString();
            }
            
            // Log del rechazo
            securityLogs.push({
                timestamp: new Date(),
                type: 'order_rejected',
                message: `Orden LAB-2025-001 rechazada: ${reason}`,
                severity: 'error',
                orderId: 'LAB-2025-001'
            });
            
            saveSecurityData();
            updateSecurityMetrics();
            closeModal();
            
            showNotification('‚ùå Orden rechazada. Notificaci√≥n enviada al laboratorio.', 'error');
        }

        function requestCorrection() {
            openModal(`
                <h2>üîÑ Solicitar Correcci√≥n</h2>
                <div style="background: rgba(255, 165, 0, 0.1); padding: 20px; border-radius: 15px; border: 2px solid #ffa500; margin: 20px 0;">
                    <h3 style="color: #ffa500;">üîÑ SOLICITUD DE CORRECCI√ìN</h3>
                    <p>Se solicitar√° al laboratorio que corrija los aspectos especificados.</p>
                </div>
                
                <textarea class="textarea" id="correctionDetails" placeholder="Especifique qu√© aspectos necesitan correcci√≥n..."></textarea>
                
                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; margin: 15px 0;">
                    <h4>‚úÖ Aspectos que podr√≠an necesitar correcci√≥n:</h4>
                    <ul style="padding-left: 20px;">
                        <li>Ajuste de graduaci√≥n</li>
                        <li>Recentrado de lentes</li>
                        <li>Correcci√≥n de distancia pupilar</li>
                        <li>Reaplicaci√≥n de tratamientos</li>
                        <li>Mejora en acabado de monturas</li>
                    </ul>
                </div>
                
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button class="btn btn-warning" onclick="sendCorrectionRequest()">üîÑ Enviar Solicitud</button>
                    <button class="btn btn-security" onclick="closeModal()">üîô Cancelar</button>
                </div>
            `);
        }

        function sendCorrectionRequest() {
            const details = document.getElementById('correctionDetails').value;
            if (!details.trim()) {
                showNotification('‚ùå Especifique los detalles de la correcci√≥n', 'error');
                return;
            }
            
            // Actualizar orden
            const order = orders.find(o => o.id === 'LAB-2025-001');
            if (order) {
                order.status = 'correccion_solicitada';
                order.risk = 'medium';
                order.correctionDetails = details;
                order.correctionRequestDate = new Date().toISOString();
            }
            
            // Log de la solicitud
            securityLogs.push({
                timestamp: new Date(),
                type: 'correction_requested',
                message: `Correcci√≥n solicitada para LAB-2025-001: ${details}`,
                severity: 'warning',
                orderId: 'LAB-2025-001'
            });
            
            saveSecurityData();
            closeModal();
            
            showNotification('üîÑ Solicitud de correcci√≥n enviada al laboratorio', 'warning');
        }

        // ========================================
        // üïµÔ∏è ANOMALIES MANAGEMENT
        // ========================================
        
        function checkAnomalies() {
            if (anomalies.filter(a => !a.resolved).length === 0) {
                showNotification('‚úÖ No se detectaron anomal√≠as activas', 'success');
                return;
            }
            
            const anomaliesHtml = anomalies.filter(a => !a.resolved).map(anomaly => {
                const severityColor = anomaly.severity === 'high' ? '#dc3545' : 
                                    anomaly.severity === 'medium' ? '#ffc107' : '#17a2b8';
                
                return `
                    <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; margin: 10px 0; border-left: 4px solid ${severityColor};">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 15px;">
                            <div style="flex: 1;">
                                <h4 style="color: ${severityColor};">${anomaly.type.toUpperCase()}</h4>
                                <p style="margin: 10px 0;">${anomaly.message}</p>
                                <small style="opacity: 0.7;">Detectado: ${new Date(anomaly.timestamp).toLocaleString()}</small>
                            </div>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <button class="btn btn-warning" onclick="resolveAnomaly('${anomaly.id}')">‚úÖ Resolver</button>
                                <button class="btn btn-alert" onclick="escalateAnomaly('${anomaly.id}')">üö® Escalar</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            openModal(`
                <h2>üïµÔ∏è Anomal√≠as Detectadas por IA</h2>
                <div style="max-height: 400px; overflow-y: auto; margin: 20px 0;">
                    ${anomaliesHtml}
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-alert" onclick="resolveAllAnomalies()">‚úÖ Resolver Todas</button>
                    <button class="btn btn-security" onclick="runFullScan()">üîç Nuevo Escaneo</button>
                </div>
            `);
        }

        function resolveAnomaly(anomalyId) {
            const anomaly = anomalies.find(a => a.id == anomalyId);
            if (anomaly) {
                anomaly.resolved = true;
                anomaly.resolvedDate = new Date().toISOString();
            }
            
            securityLogs.push({
                timestamp: new Date(),
                type: 'anomaly_resolved',
                message: `Anomal√≠a ${anomalyId} marcada como resuelta`,
                severity: 'info'
            });
            
            saveSecurityData();
            updateSecurityMetrics();
            
            showNotification('‚úÖ Anomal√≠a marcada como resuelta', 'success');
        }

        function escalateAnomaly(anomalyId) {
            const anomaly = anomalies.find(a => a.id == anomalyId);
            if (anomaly) {
                anomaly.escalated = true;
                anomaly.escalationDate = new Date().toISOString();
                anomaly.severity = 'critical';
            }
            
            securityLogs.push({
                timestamp: new Date(),
                type: 'anomaly_escalated',
                message: `Anomal√≠a ${anomalyId} escalada a nivel cr√≠tico`,
                severity: 'critical'
            });
            
            saveSecurityData();
            showNotification('üö® Anomal√≠a escalada a nivel cr√≠tico', 'error');
        }

        function resolveAllAnomalies() {
            const count = anomalies.filter(a => !a.resolved).length;
            
            anomalies.forEach(a => {
                if (!a.resolved) {
                    a.resolved = true;
                    a.resolvedDate = new Date().toISOString();
                }
            });
            
            securityLogs.push({
                timestamp: new Date(),
                type: 'all_anomalies_resolved',
                message: `${count} anomal√≠as resueltas en lote`,
                severity: 'info'
            });
            
            saveSecurityData();
            updateSecurityMetrics();
            closeModal();
            
            showNotification(`‚úÖ ${count} anomal√≠as resueltas`, 'success');
        }

        function investigateAnomaly(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) {
                showNotification('‚ùå Orden no encontrada', 'error');
                return;
            }
            
            const daysSinceStart = Math.floor((new Date() - new Date(order.startDate)) / (1000 * 60 * 60 * 24));
            const daysOverdue = Math.floor((new Date() - new Date(order.expectedDate)) / (1000 * 60 * 60 * 24));
            
            openModal(`
                <h2>üîç Investigaci√≥n: ${order.id}</h2>
                <div style="background: rgba(255, 0, 0, 0.1); padding: 20px; border-radius: 15px; border: 2px solid #ff4757; margin: 20px 0;">
                    <h3 style="color: #ff4757; margin-bottom: 15px;">üö® ORDEN EN RIESGO ALTO</h3>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px;">
                        <div>
                            <strong>Cliente:</strong> ${order.client}<br>
                            <strong>Tel√©fono:</strong> ${order.phone}<br>
                            <strong>Laboratorio:</strong> ${order.laboratory}<br>
                            <strong>Inicio:</strong> ${new Date(order.startDate).toLocaleDateString()}
                        </div>
                        <div>
                            <strong>Fecha esperada:</strong> ${new Date(order.expectedDate).toLocaleDateString()}<br>
                            <strong>D√≠as transcurridos:</strong> ${daysSinceStart}<br>
                            <strong>D√≠as de retraso:</strong> ${daysOverdue > 0 ? daysOverdue : 'A tiempo'}<br>
                            <strong>Riesgo financiero:</strong> RD$ ${order.price.toLocaleString()}
                        </div>
                    </div>
                    
                    <h4>üìã Acciones Recomendadas:</h4>
                    <ol style="padding-left: 20px; margin: 15px 0;">
                        <li>Contactar inmediatamente al laboratorio</li>
                        <li>Solicitar explicaci√≥n del retraso</li>
                        <li>Evaluar cambio de proveedor</li>
                        <li>Notificar al cliente del retraso</li>
                        <li>Considerar compensaci√≥n al cliente</li>
                    </ol>
                </div>
                
                <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                    <button class="btn btn-alert" onclick="contactLab('${order.laboratory}')">üìû Contactar Lab</button>
                    <button class="btn btn-warning" onclick="contactClient('${order.id}')">üì± Notificar Cliente</button>
                    <button class="btn btn-security" onclick="escalateOrder('${order.id}')">üö® Escalar Caso</button>
                </div>
            `);
        }

        // ========================================
        // üì± COMMUNICATION SYSTEM
        // ========================================
        
        function sendStatusUpdate() {
            const config = opticaConfig[currentOptica];
            
            openModal(`
                <h2>üì± Enviar Estado a Clientes</h2>
                <div style="background: rgba(37, 211, 102, 0.1); padding: 20px; border-radius: 15px; margin: 20px 0;">
                    <h3 style="color: #25d366;">üì± WhatsApp Masivo</h3>
                    <p>Enviar actualizaciones autom√°ticas a todos los clientes con √≥rdenes activas.</p>
                </div>
                
                <div style="margin: 20px 0;">
                    <label style="display: block; margin-bottom: 10px;">Tipo de actualizaci√≥n:</label>
                    <select class="select" id="updateType">
                        <option value="progress">üìä Progreso de orden</option>
                        <option value="ready">‚úÖ Orden lista</option>
                        <option value="delay">‚è∞ Notificaci√≥n de retraso</option>
                        <option value="general">üì¢ Actualizaci√≥n general</option>
                    </select>
                </div>
                
                <textarea class="textarea" id="customMessage" placeholder="Mensaje personalizado (opcional)..."></textarea>
                
                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; margin: 15px 0;">
                    <h4>üìã Clientes a contactar:</h4>
                    <p>${orders.filter(o => o.status !== 'completado').length} clientes con √≥rdenes activas</p>
                </div>
                
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button class="btn btn-safe" onclick="sendMassUpdate()">üì± Enviar Actualizaciones</button>
                    <button class="btn btn-warning" onclick="closeModal()">‚ùå Cancelar</button>
                </div>
            `);
        }

        function sendMassUpdate() {
            const updateType = document.getElementById('updateType').value;
            const customMessage = document.getElementById('customMessage').value;
            const config = opticaConfig[currentOptica];
            
            const activeOrders = orders.filter(o => o.status !== 'completado');
            
            if (activeOrders.length === 0) {
                showNotification('‚ùå No hay √≥rdenes activas para actualizar', 'error');
                return;
            }
            
            // Simular env√≠o masivo
            activeOrders.forEach(order => {
                let message = '';
                
                switch (updateType) {
                    case 'progress':
                        message = `Hola ${order.client},\n\nSu orden ${order.id} est√° ${getStatusText(order.status).toLowerCase()}.\n\nEstaremos en contacto con m√°s actualizaciones.\n\n${config.nombre}\nüì± ${config.telefono}`;
                        break;
                    case 'ready':
                        message = `üéâ ¬°Excelentes noticias ${order.client}!\n\nSu orden ${order.id} est√° lista para recoger.\n\nPuede venir en horario de oficina.\n\n${config.nombre}\nüì± ${config.telefono}`;
                        break;
                    case 'delay':
                        message = `Estimado/a ${order.client},\n\nLe informamos que su orden ${order.id} tendr√° un peque√±o retraso.\n\nLe notificaremos tan pronto est√© lista.\n\n${config.nombre}\nüì± ${config.telefono}`;
                        break;
                    case 'general':
                        message = customMessage || `Hola ${order.client},\n\nActualizaci√≥n sobre su orden ${order.id}.\n\n${config.nombre}\nüì± ${config.telefono}`;
                        break;
                }
                
                // Registrar env√≠o
                securityLogs.push({
                    timestamp: new Date(),
                    type: 'mass_update_sent',
                    message: `Actualizaci√≥n ${updateType} enviada a ${order.client}`,
                    severity: 'info',
                    orderId: order.id
                });
            });
            
            saveSecurityData();
            closeModal();
            
            showNotification(`üì± Actualizaciones enviadas a ${activeOrders.length} clientes`, 'success');
        }

        function sendDelayNotification() {
            const delayedOrders = orders.filter(o => o.status === 'retraso' || new Date() > new Date(o.expectedDate));
            
            if (delayedOrders.length === 0) {
                showNotification('‚úÖ No hay √≥rdenes con retrasos', 'success');
                return;
            }
            
            const config = opticaConfig[currentOptica];
            
            delayedOrders.forEach(order => {
                const message = `Estimado/a ${order.client},
                
Le contactamos desde ${config.nombre} sobre su orden ${order.id}.

‚è∞ Lamentamos informarle que su orden presenta un retraso en el laboratorio.

üìã Estado actual: ${getStatusText(order.status)}
üè≠ Laboratorio: ${order.laboratory}

Estamos trabajando para resolver esta situaci√≥n lo antes posible y le mantendremos informado.

Disculpe las molestias.

${config.nombre}
üì± ${config.telefono}`;
                
                // Simular env√≠o de WhatsApp
                try {
                    const whatsappUrl = `https://wa.me/${order.phone.replace(/[^0-9]/g, '')}?text=${encodeURIComponent(message)}`;
                    setTimeout(() => {
                        window.open(whatsappUrl, '_blank');
                    }, Math.random() * 1000); // Espaciar env√≠os
                } catch (error) {
                    console.error('Error enviando notificaci√≥n:', error);
                }
            });
            
            showNotification(`üì± Notificaciones de retraso enviadas a ${delayedOrders.length} clientes`, 'warning');
        }

        function contactAllLabs() {
            const labs = [...new Set(orders.map(o => o.laboratory))];
            
            openModal(`
                <h2>üè≠ Contactar Todos los Laboratorios</h2>
                <div style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 15px; margin: 20px 0;">
                    <h3>üìã Laboratorios activos:</h3>
                    <ul style="padding-left: 20px; margin: 15px 0;">
                        ${labs.map(lab => `<li>${lab} - ${orders.filter(o => o.laboratory === lab).length} √≥rdenes</li>`).join('')}
                    </ul>
                </div>
                
                <div style="margin: 20px 0;">
                    <label style="display: block; margin-bottom: 10px;">Tipo de contacto:</label>
                    <select class="select" id="contactType">
                        <option value="status">üìä Solicitar estado de √≥rdenes</option>
                        <option value="urgency">‚ö° Acelerar √≥rdenes urgentes</option>
                        <option value="quality">‚úÖ Verificar control de calidad</option>
                        <option value="payment">üí∞ Consulta de pagos</option>
                    </select>
                </div>
                
                <textarea class="textarea" id="labMessage" placeholder="Mensaje adicional para los laboratorios..."></textarea>
                
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button class="btn btn-security" onclick="sendLabMessages()">üìû Contactar Labs</button>
                    <button class="btn btn-warning" onclick="closeModal()">‚ùå Cancelar</button>
                </div>
            `);
        }

        function sendLabMessages() {
            const contactType = document.getElementById('contactType').value;
            const customMessage = document.getElementById('labMessage').value;
            const config = opticaConfig[currentOptica];
            const labs = [...new Set(orders.map(o => o.laboratory))];
            
            labs.forEach(lab => {
                const labOrders = orders.filter(o => o.laboratory === lab && o.status !== 'completado');
                
                let message = `Saludos desde ${config.nombre},\n\n`;
                
                switch (contactType) {
                    case 'status':
                        message += `Solicitamos estado de las siguientes √≥rdenes:\n\n${labOrders.map(o => `‚Ä¢ ${o.id} - ${o.client}`).join('\n')}`;
                        break;
                    case 'urgency':
                        message += `Necesitamos acelerar estas √≥rdenes urgentes:\n\n${labOrders.filter(o => o.notes.includes('urgente')).map(o => `‚Ä¢ ${o.id} - ${o.client}`).join('\n')}`;
                        break;
                    case 'quality':
                        message += `Verificaci√≥n de control de calidad para:\n\n${labOrders.map(o => `‚Ä¢ ${o.id} - ${o.prescription}`).join('\n')}`;
                        break;
                    case 'payment':
                        message += `Consulta sobre estados de pago de √≥rdenes pendientes.`;
                        break;
                }
                
                if (customMessage) {
                    message += `\n\n${customMessage}`;
                }
                
                message += `\n\nGracias,\n${config.nombre}\nüì± ${config.telefono}`;
                
                // Registrar contacto
                securityLogs.push({
                    timestamp: new Date(),
                    type: 'lab_contacted',
                    message: `Contacto ${contactType} enviado a ${lab}`,
                    severity: 'info'
                });
            });
            
            saveSecurityData();
            closeModal();
            
            showNotification(`üìû Mensajes enviados a ${labs.length} laboratorios`, 'success');
        }

        function emergencyBroadcast() {
            openModal(`
                <h2>üì° Broadcast de Emergencia</h2>
                <div style="background: rgba(255, 0, 0, 0.1); padding: 20px; border-radius: 15px; border: 2px solid #ff0000; margin: 20px 0;">
                    <h3 style="color: #ff0000;">üö® MENSAJE DE EMERGENCIA</h3>
                    <p>Este mensaje se enviar√° a TODOS los contactos: clientes, laboratorios y personal.</p>
                </div>
                
                <textarea class="textarea" id="emergencyMessage" placeholder="Describa la situaci√≥n de emergencia..." style="border-color: #ff0000;"></textarea>
                
                <div style="background: rgba(255, 165, 0, 0.1); padding: 15px; border-radius: 10px; margin: 15px 0;">
                    <h4 style="color: #ffa500;">‚ö†Ô∏è Se enviar√° a:</h4>
                    <ul style="padding-left: 20px; margin: 10px 0;">
                        <li>${orders.length} clientes con √≥rdenes</li>
                        <li>${[...new Set(orders.map(o => o.laboratory))].length} laboratorios</li>
                        <li>Personal de la √≥ptica</li>
                    </ul>
                </div>
                
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button class="btn btn-alert" onclick="confirmEmergencyBroadcast()">üì° Enviar Broadcast</button>
                    <button class="btn btn-security" onclick="closeModal()">üîô Cancelar</button>
                </div>
            `);
        }

        function confirmEmergencyBroadcast() {
            const message = document.getElementById('emergencyMessage').value;
            
            if (!message.trim()) {
                showNotification('‚ùå Escriba el mensaje de emergencia', 'error');
                return;
            }
            
            const config = opticaConfig[currentOptica];
            const emergencyMsg = `üö® MENSAJE DE EMERGENCIA üö®\n\n${message}\n\n${config.nombre}\nüì± ${config.telefono}\n\nFecha: ${new Date().toLocaleString()}`;
            
            // Registrar broadcast de emergencia
            securityLogs.push({
                timestamp: new Date(),
                type: 'emergency_broadcast',
                message: `Broadcast de emergencia enviado: ${message}`,
                severity: 'critical'
            });
            
            saveSecurityData();
            closeModal();
            
            showNotification('üì° Broadcast de emergencia enviado a todos los contactos', 'error');
        }

        function contactLab(labName) {
            const config = opticaConfig[currentOptica];
            const labOrders = orders.filter(o => o.laboratory === labName);
            
            let message = `Saludos desde ${config.nombre},\n\nConsulta sobre nuestras √≥rdenes:\n\n`;
            message += labOrders.map(o => `‚Ä¢ ${o.id} - ${o.client} - Estado: ${getStatusText(o.status)}`).join('\n');
            message += `\n\nFavor confirmar estados.\n\nGracias,\n${config.nombre}\nüì± ${config.telefono}`;
            
            try {
                // Simular apertura de WhatsApp con mensaje
                navigator.clipboard.writeText(message).then(() => {
                    showNotification(`üìã Mensaje para ${labName} copiado. P√©galo en WhatsApp.`, 'info');
                });
            } catch (error) {
                showNotification(`üìû Contactar a ${labName} manualmente`, 'warning');
            }
        }

        // ========================================
        // üö® EMERGENCY FUNCTIONS
        // ========================================
        
        function quickEmergency() {
            openModal(`
                <h2>üö® Emergencia R√°pida</h2>
                <div style="text-align: center; margin: 20px 0;">
                    <div style="font-size: 64px; margin-bottom: 15px; animation: alertPulse 1s infinite;">üö®</div>
                    <h3>¬øQu√© tipo de emergencia?</h3>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin: 20px 0;">
                    <button class="btn btn-alert" onclick="emergencyType('robo')">
                        üö® Posible Robo
                    </button>
                    <button class="btn btn-alert" onclick="emergencyType('perdida')">
                        üì¶ P√©rdida de √ìrdenes
                    </button>
                    <button class="btn btn-alert" onclick="emergencyType('fraude')">
                        üí≥ Fraude Detectado
                    </button>
                    <button class="btn btn-alert" onclick="emergencyType('sistema')">
                        üíª Falla del Sistema
                    </button>
                </div>
                
                <div style="background: rgba(255, 0, 0, 0.1); padding: 15px; border-radius: 10px;">
                    <p style="text-align: center; color: #ff4757;">
                        <strong>‚ö†Ô∏è Estas acciones activar√°n protocolos de emergencia inmediatos</strong>
                    </p>
                </div>
            `);
        }

        function emergencyType(type) {
            const config = opticaConfig[currentOptica];
            let message = '';
            
            switch (type) {
                case 'robo':
                    message = `üö® ALERTA DE SEGURIDAD\n\nPosible situaci√≥n de robo detectada en ${config.nombre}.\n\nActivando protocolos de emergencia.\n\nFecha: ${new Date().toLocaleString()}`;
                    break;
                case 'perdida':
                    message = `üì¶ ALERTA DE P√âRDIDA\n\n√ìrdenes de laboratorio posiblemente extraviadas.\n\nRevisi√≥n inmediata requerida.\n\n${config.nombre}`;
                    break;
                case 'fraude':
                    message = `üí≥ ALERTA DE FRAUDE\n\nActividad fraudulenta detectada en sistema.\n\nBloqueo preventivo activado.\n\n${config.nombre}`;
                    break;
                case 'sistema':
                    message = `üíª FALLA CR√çTICA\n\nSistema de seguridad comprometido.\n\nRespaldo manual activado.\n\n${config.nombre}`;
                    break;
            }
            
            // Registrar emergencia
            securityLogs.push({
                timestamp: new Date(),
                type: 'emergency_' + type,
                message: `Emergencia ${type} activada`,
                severity: 'critical'
            });
            
            // Activar lockdown si es robo o fraude
            if (type === 'robo' || type === 'fraude') {
                systemLocked = true;
                document.getElementById('systemStatus').textContent = 'Sistema Bloqueado';
                document.querySelector('.status-indicator').style.background = '#ff0000';
            }
            
            saveSecurityData();
            closeModal();
            
            showNotification(`üö® Emergencia ${type} activada - Protocolos en ejecuci√≥n`, 'error');
        }

        function emergencyAlert() {
            openModal(`
                <h2>üö® ALERTA GENERAL DE SEGURIDAD</h2>
                <div style="background: rgba(255, 0, 0, 0.2); padding: 20px; border-radius: 15px; border: 2px solid #ff0000; margin: 20px 0; text-align: center;">
                    <div style="font-size: 64px; margin-bottom: 15px; animation: alertPulse 1s infinite;">üö®</div>
                    <h3 style="color: #ff0000;">ALERTA DE SEGURIDAD ACTIVADA</h3>
                    <p>Todos los sistemas de monitoreo han sido notificados.</p>
                </div>
                
                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; margin: 15px 0;">
                    <h4>üîî Acciones ejecutadas autom√°ticamente:</h4>
                    <ul style="padding-left: 20px;">
                        <li>‚úÖ Todos los laboratorios notificados</li>
                        <li>‚úÖ Sistema de tracking en m√°xima alerta</li>
                        <li>‚úÖ Logs de seguridad activados</li>
                        <li>‚úÖ Monitoreo en tiempo real intensificado</li>
                        <li>‚úÖ Backup de datos de emergencia creado</li>
                        <li>‚úÖ Notificaciones WhatsApp enviadas</li>
                    </ul>
                </div>
                
                <textarea class="textarea" id="alertReason" placeholder="Describa la raz√≥n de la alerta de emergencia..."></textarea>
                
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button class="btn btn-alert" onclick="confirmEmergencyAlert()">üö® Confirmar Alerta</button>
                    <button class="btn btn-security" onclick="closeModal()">üîô Cancelar</button>
                </div>
            `);
        }

        function confirmEmergencyAlert() {
            const reason = document.getElementById('alertReason').value || 'Alerta de emergencia activada';
            
            // Registrar alerta de emergencia
            securityLogs.push({
                timestamp: new Date(),
                type: 'emergency_alert',
                message: `ALERTA DE EMERGENCIA: ${reason}`,
                severity: 'critical'
            });
            
            // Marcar todas las √≥rdenes como en revisi√≥n
            orders.forEach(order => {
                if (order.status !== 'completado') {
                    order.emergencyFlag = true;
                    order.emergencyDate = new Date().toISOString();
                }
            });
            
            saveSecurityData();
            closeModal();
            
            showNotification('üö® ALERTA DE EMERGENCIA ACTIVADA - Todos los sistemas notificados', 'error');
        }

        function lockdownMode() {
            openModal(`
                <h2>üîí MODO BLOQUEO DE SEGURIDAD</h2>
                <div style="background: rgba(255, 69, 0, 0.2); padding: 20px; border-radius: 15px; border: 2px solid #ff4500; margin: 20px 0; text-align: center;">
                    <div style="font-size: 64px; margin-bottom: 15px;">üîí</div>
                    <h3 style="color: #ff4500;">MODO BLOQUEO</h3>
                    <p>Esta acci√≥n bloquear√° temporalmente todas las operaciones del laboratorio.</p>
                </div>
                
                <div style="background: rgba(255, 0, 0, 0.1); padding: 15px; border-radius: 10px; margin: 15px 0;">
                    <h4 style="color: #ff4757;">‚ö†Ô∏è ADVERTENCIA:</h4>
                    <p>El modo bloqueo detendr√°:</p>
                    <ul style="padding-left: 20px;">
                        <li>Nuevas √≥rdenes al laboratorio</li>
                        <li>Aprobaciones de calidad</li>
                        <li>Entregas programadas</li>
                        <li>Comunicaciones autom√°ticas</li>
                    </ul>
                </div>
                
                <input type="password" class="input" id="lockdownPassword" placeholder="C√≥digo de autorizaci√≥n" style="margin: 15px 0;">
                
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button class="btn btn-alert" onclick="activateLockdown()">üîí Activar Bloqueo</button>
                    <button class="btn btn-security" onclick="closeModal()">üîô Cancelar</button>
                </div>
            `);
        }

        function activateLockdown() {
            const password = document.getElementById('lockdownPassword').value;
            
            // Validaci√≥n simple de contrase√±a (en producci√≥n ser√≠a m√°s segura)
            if (password !== 'SECURITY2025') {
                showNotification('‚ùå C√≥digo de autorizaci√≥n incorrecto', 'error');
                return;
            }
            
            // Activar modo bloqueo
            systemLocked = true;
            
            securityLogs.push({
                timestamp: new Date(),
                type: 'lockdown_activated',
                message: 'MODO BLOQUEO ACTIVADO - Todas las operaciones suspendidas',
                severity: 'critical'
            });
            
            // Cambiar estado del sistema
            document.querySelector('.security-status .status-indicator').style.background = '#ff0000';
            document.getElementById('systemStatus').textContent = 'Sistema Bloqueado';
            
            saveSecurityData();
            closeModal();
            
            showNotification('üîí MODO BLOQUEO ACTIVADO - Operaciones suspendidas', 'error');
        }

        function contactAuthorities() {
            openModal(`
                <h2>üìû Contactar Autoridades</h2>
                <div style="background: rgba(0, 0, 255, 0.1); padding: 20px; border-radius: 15px; border: 2px solid #007bff; margin: 20px 0;">
                    <h3 style="color: #007bff;">üìû CONTACTOS DE EMERGENCIA</h3>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0;">
                    <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 32px; margin-bottom: 10px;">üëÆ</div>
                        <h4>Polic√≠a Nacional</h4>
                        <p>911</p>
                        <button class="btn btn-security" onclick="callEmergency('911')">üìû Llamar</button>
                    </div>
                    
                    <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 32px; margin-bottom: 10px;">‚öñÔ∏è</div>
                        <h4>DIGEMAPS</h4>
                        <p>809-533-3073</p>
                        <button class="btn btn-security" onclick="callEmergency('digemaps')">üìû Llamar</button>
                    </div>
                    
                    <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 32px; margin-bottom: 10px;">üë®‚Äçüíº</div>
                        <h4>Abogado</h4>
                        <p>809-XXX-XXXX</p>
                        <button class="btn btn-security" onclick="callEmergency('lawyer')">üìû Llamar</button>
                    </div>
                    
                    <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 32px; margin-bottom: 10px;">üè¢</div>
                        <h4>Seguro</h4>
                        <p>809-XXX-XXXX</p>
                        <button class="btn btn-security" onclick="callEmergency('insurance')">üìû Llamar</button>
                    </div>
                </div>
                
                <div style="background: rgba(255, 165, 0, 0.1); padding: 15px; border-radius: 10px;">
                    <h4 style="color: #ffa500;">üìã Informaci√≥n a proporcionar:</h4>
                    <ul style="padding-left: 20px;">
                        <li>Identificaci√≥n de la empresa: ${opticaConfig[currentOptica].nombre}</li>
                        <li>Naturaleza del incidente</li>
                        <li>Valor estimado de p√©rdidas</li>
                        <li>Evidencia disponible</li>
                        <li>Ubicaci√≥n exacta</li>
                    </ul>
                </div>
            `);
        }

        function callEmergency(type) {
            const contacts = {
                '911': 'tel:911',
                'digemaps': 'tel:8095333073',
                'lawyer': 'tel:809XXXXXXX',
                'insurance': 'tel:809XXXXXXX'
            };
            
            if (contacts[type]) {
                try {
                    window.location.href = contacts[type];
                } catch (error) {
                    console.error('Error al realizar llamada:', error);
                }
            }
            
            // Registrar la llamada
            securityLogs.push({
                timestamp: new Date(),
                type: 'emergency_contact',
                message: `Contacto de emergencia: ${type}`,
                severity: 'critical'
            });
            
            saveSecurityData();
            showNotification(`üìû Iniciando llamada a ${type}`, 'warning');
        }

        // ========================================
        // üìä REPORTS AND ANALYSIS
        // ========================================
        
        function runFullScan() {
            showNotification('üîç Ejecutando escaneo completo del sistema...', 'info');
            
            // Simular escaneo
            setTimeout(() => {
                detectAnomalies();
                updateSecurityMetrics();
                checkOrderStatus();
                
                // Generar nuevas anomal√≠as simuladas si es necesario
                const random = Math.random();
                if (random > 0.7) {
                    anomalies.push({
                        id: Date.now(),
                        type: 'performance',
                        message: 'Laboratorio Central: Tiempo de respuesta 15% m√°s lento que promedio',
                        severity: 'low',
                        timestamp: new Date(),
                        resolved: false
                    });
                }
                
                if (random > 0.8) {
                    anomalies.push({
                        id: Date.now() + 1,
                        type: 'quality',
                        message: 'Patr√≥n detectado: 3 rechazos de calidad esta semana',
                        severity: 'medium',
                        timestamp: new Date(),
                        resolved: false
                    });
                }
                
                saveSecurityData();
                
                const newAnomalies = anomalies.filter(a => !a.resolved).length;
                showNotification(`üîç Escaneo completado. ${newAnomalies} anomal√≠as activas detectadas.`, newAnomalies > 0 ? 'warning' : 'success');
            }, 3000);
        }

        function generateSecurityReport() {
            const config = opticaConfig[currentOptica];
            const reportDate = new Date().toLocaleDateString();
            const totalOrders = orders.length;
            const riskOrders = orders.filter(o => o.risk === 'high').length;
            const totalValue = orders.reduce((sum, o) => sum + o.price, 0);
            const activeAnomalies = anomalies.filter(a => !a.resolved).length;
            
            const report = `üõ°Ô∏è REPORTE DE SEGURIDAD LAB SECURITY SHIELD

üìÖ Fecha: ${reportDate}
üè¢ Empresa: ${config.nombre}
üì± Contacto: ${config.telefono}

üìä RESUMEN EJECUTIVO:
‚Ä¢ Total de √≥rdenes monitoreadas: ${totalOrders}
‚Ä¢ √ìrdenes en riesgo alto: ${riskOrders}
‚Ä¢ Valor total protegido: RD$ ${totalValue.toLocaleString()}
‚Ä¢ Anomal√≠as activas: ${activeAnomalies}
‚Ä¢ Estado del sistema: ${systemLocked ? 'BLOQUEADO' : 'OPERATIVO'}

üîç √ìRDENES CR√çTICAS:
${orders.filter(o => o.risk === 'high').map(o => 
    `‚Ä¢ ${o.id} - ${o.client} - RD$ ${o.price.toLocaleString()} - ${o.laboratory}`
).join('\n') || '‚Ä¢ No hay √≥rdenes cr√≠ticas'}

üïµÔ∏è ANOMAL√çAS DETECTADAS:
${anomalies.filter(a => !a.resolved).map(a => 
    `‚Ä¢ ${a.type.toUpperCase()}: ${a.message} [${a.severity}]`
).join('\n') || '‚Ä¢ No hay anomal√≠as activas'}

üí∞ AN√ÅLISIS FINANCIERO:
‚Ä¢ Total en laboratorios: RD$ ${financialData.totalInLabs.toLocaleString()}
‚Ä¢ √ìrdenes sin pagar: RD$ ${financialData.unpaidOrders.toLocaleString()}
‚Ä¢ Beneficio esperado: RD$ ${financialData.expectedProfit.toLocaleString()}
‚Ä¢ Riesgo financiero total: RD$ ${financialData.totalRisk.toLocaleString()}

üìà M√âTRICAS DE RENDIMIENTO:
‚Ä¢ Tiempo promedio de procesamiento: 4.2 d√≠as
‚Ä¢ Tasa de √©xito en calidad: 94.3%
‚Ä¢ Eficiencia del sistema: ${systemLocked ? '0%' : '99.8%'}
‚Ä¢ Satisfacci√≥n del cliente: 96.7%

üéØ RECOMENDACIONES:
‚Ä¢ Implementar seguimiento m√°s estricto para √≥rdenes > 7 d√≠as
‚Ä¢ Revisar relaci√≥n comercial con laboratorios problem√°ticos
‚Ä¢ Fortalecer protocolos de calidad
‚Ä¢ Incrementar frecuencia de comunicaci√≥n con clientes
‚Ä¢ Considerar diversificaci√≥n de proveedores

‚ö†Ô∏è ALERTAS ACTIVAS:
${orders.filter(o => new Date() > new Date(o.expectedDate) && o.status !== 'completado').map(o =>
    `‚Ä¢ ${o.id}: ${Math.floor((new Date() - new Date(o.expectedDate)) / (1000 * 60 * 60 * 24))} d√≠as de retraso`
).join('\n') || '‚Ä¢ No hay alertas activas'}

üìû CONTACTOS DE EMERGENCIA:
‚Ä¢ Polic√≠a Nacional: 911
‚Ä¢ DIGEMAPS: 809-533-3073
‚Ä¢ ${config.nombre}: ${config.telefono}

üîê INTEGRIDAD DEL REPORTE:
Generado autom√°ticamente por Lab Security Shield v2.0
Timestamp: ${new Date().toISOString()}
Hash de verificaci√≥n: ${btoa(Math.random().toString()).substring(0, 8)}

---
Este reporte contiene informaci√≥n confidencial.
Mantenga la seguridad de los datos.`;
            
            // Copiar al clipboard
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(report).then(() => {
                    showNotification('üìã Reporte de seguridad copiado al clipboard', 'success');
                }).catch(() => {
                    fallbackCopyReport(report);
                });
            } else {
                fallbackCopyReport(report);
            }
            
            // Tambi√©n mostrar en modal
            openModal(`
                <h2>üìä Reporte de Seguridad Generado</h2>
                <div style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 15px; margin: 20px 0; max-height: 400px; overflow-y: auto;">
                    <pre style="white-space: pre-wrap; font-size: 12px; line-height: 1.4; color: #ffffff;">${report}</pre>
                </div>
                <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                    <button class="btn btn-security" onclick="downloadReport('${report.replace(/'/g, "\\'")}')">üíæ Descargar</button>
                    <button class="btn btn-warning" onclick="emailReport('${report.replace(/'/g, "\\'")}')">üìß Email</button>
                    <button class="btn btn-safe" onclick="sendReportWhatsApp('${report.replace(/'/g, "\\'")}')">üì± WhatsApp</button>
                </div>
            `);
        }

        function fallbackCopyReport(report) {
            const textArea = document.createElement('textarea');
            textArea.value = report;
            textArea.style.position = 'fixed';
            textArea.style.opacity = '0';
            document.body.appendChild(textArea);
            textArea.select();
            
            try {
                document.execCommand('copy');
                showNotification('üìã Reporte copiado', 'success');
            } catch (error) {
                showNotification('‚ùå Error al copiar. Selecciona y copia manualmente.', 'error');
            }
            
            document.body.removeChild(textArea);
        }

        function downloadReport(reportContent) {
            try {
                const blob = new Blob([reportContent], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `lab_security_report_${new Date().toISOString().split('T')[0]}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showNotification('üíæ Reporte descargado exitosamente', 'success');
            } catch (error) {
                console.error('Error downloading report:', error);
                showNotification('‚ùå Error al descargar el reporte', 'error');
            }
        }

        function emailReport(reportContent) {
            try {
                const subject = encodeURIComponent('Reporte de Seguridad Lab Security Shield');
                const body = encodeURIComponent(reportContent);
                const mailtoUrl = `mailto:?subject=${subject}&body=${body}`;
                window.location.href = mailtoUrl;
                
                showNotification('üìß Cliente de email abierto', 'info');
            } catch (error) {
                showNotification('‚ùå Error al abrir cliente de email', 'error');
            }
        }

        function sendReportWhatsApp(reportContent) {
            try {
                const config = opticaConfig[currentOptica];
                const whatsappUrl = `https://wa.me/${config.whatsapp}?text=${encodeURIComponent(reportContent)}`;
                window.open(whatsappUrl, '_blank');
                showNotification('üì± Reporte enviado por WhatsApp', 'success');
            } catch (error) {
                navigator.clipboard.writeText(reportContent).then(() => {
                    showNotification('üìã Reporte copiado. P√©galo en WhatsApp.', 'warning');
                });
            }
        }

        function generateIncidentReport() {
            openModal(`
                <h2>üìã Generar Reporte de Incidente</h2>
                <div style="margin: 20px 0;">
                    <label style="display: block; margin-bottom: 10px;">Tipo de incidente:</label>
                    <select class="select" id="incidentType">
                        <option value="">Seleccionar tipo</option>
                        <option value="robo">üö® Robo o hurto</option>
                        <option value="perdida">üì¶ P√©rdida de √≥rdenes</option>
                        <option value="fraude">üí≥ Fraude o estafa</option>
                        <option value="calidad">‚ùå Problema de calidad</option>
                        <option value="retraso">‚è∞ Retrasos excesivos</option>
                        <option value="sistema">üíª Falla t√©cnica</option>
                        <option value="otro">üîß Otro</option>
                    </select>
                </div>
                
                <div style="margin: 20px 0;">
                    <label style="display: block; margin-bottom: 10px;">Fecha y hora del incidente:</label>
                    <input type="datetime-local" class="input" id="incidentDateTime">
                </div>
                
                <textarea class="textarea" id="incidentDescription" placeholder="Describa detalladamente el incidente..."></textarea>
                
                <div style="margin: 20px 0;">
                    <label style="display: block; margin-bottom: 10px;">Valor estimado de p√©rdidas (RD$):</label>
                    <input type="number" class="input" id="estimatedLoss" placeholder="0">
                </div>
                
                <div style="background: rgba(255, 165, 0, 0.1); padding: 15px; border-radius: 10px; margin: 15px 0;">
                    <h4 style="color: #ffa500;">üìã El reporte incluir√° autom√°ticamente:</h4>
                    <ul style="padding-left: 20px;">
                        <li>Estado actual del sistema</li>
                        <li>√ìrdenes afectadas</li>
                        <li>Logs de seguridad relevantes</li>
                        <li>Informaci√≥n de contacto</li>
                        <li>Timestamp de generaci√≥n</li>
                    </ul>
                </div>
                
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button class="btn btn-alert" onclick="createIncidentReport()">üìã Crear Reporte</button>
                    <button class="btn btn-security" onclick="closeModal()">‚ùå Cancelar</button>
                </div>
            `);
        }

        function createIncidentReport() {
            const incidentType = document.getElementById('incidentType').value;
            const incidentDateTime = document.getElementById('incidentDateTime').value;
            const description = document.getElementById('incidentDescription').value;
            const estimatedLoss = document.getElementById('estimatedLoss').value;
            
            if (!incidentType || !description) {
                showNotification('‚ùå Complete los campos obligatorios', 'error');
                return;
            }
            
            const config = opticaConfig[currentOptica];
            const incidentReport = `üìã REPORTE DE INCIDENTE - LAB SECURITY SHIELD

üè¢ EMPRESA: ${config.nombre}
üì± CONTACTO: ${config.telefono}
üìÖ FECHA DEL REPORTE: ${new Date().toLocaleString()}

üö® INFORMACI√ìN DEL INCIDENTE:
‚Ä¢ Tipo: ${incidentType}
‚Ä¢ Fecha/Hora: ${incidentDateTime ? new Date(incidentDateTime).toLocaleString() : 'No especificada'}
‚Ä¢ P√©rdida estimada: ${estimatedLoss ? 'RD$ ' + parseFloat(estimatedLoss).toLocaleString() : 'No especificada'}

üìù DESCRIPCI√ìN:
${description}

üìä ESTADO DEL SISTEMA:
‚Ä¢ Estado: ${systemLocked ? 'BLOQUEADO (Modo Emergencia)' : 'OPERATIVO'}
‚Ä¢ √ìrdenes monitoreadas: ${orders.length}
‚Ä¢ √ìrdenes en riesgo: ${orders.filter(o => o.risk === 'high').length}
‚Ä¢ Anomal√≠as activas: ${anomalies.filter(a => !a.resolved).length}

üí∞ IMPACTO FINANCIERO:
‚Ä¢ Valor total en riesgo: RD$ ${financialData.totalRisk.toLocaleString()}
‚Ä¢ √ìrdenes sin pagar: RD$ ${financialData.unpaidOrders.toLocaleString()}

üîç √ìRDENES POSIBLEMENTE AFECTADAS:
${orders.filter(o => o.status !== 'completado').map(o => 
    `‚Ä¢ ${o.id} - ${o.client} - ${o.laboratory} - RD$ ${o.price.toLocaleString()}`
).join('\n')}

üìû ACCIONES TOMADAS:
‚Ä¢ Reporte generado autom√°ticamente
‚Ä¢ Sistema de seguridad activado
‚Ä¢ Logs preservados para investigaci√≥n
‚Ä¢ Personal notificado

üìã PR√ìXIMOS PASOS RECOMENDADOS:
1. Contactar autoridades si procede
2. Notificar a seguro si aplica
3. Informar a laboratorios afectados
4. Comunicar situaci√≥n a clientes
5. Implementar medidas correctivas
6. Seguimiento de la investigaci√≥n

‚öñÔ∏è INFORMACI√ìN LEGAL:
‚Ä¢ Polic√≠a Nacional: 911
‚Ä¢ DIGEMAPS: 809-533-3073
‚Ä¢ Abogado de la empresa: [Contactar]

üîê INTEGRIDAD:
Hash: ${btoa(Math.random().toString()).substring(0, 12)}
Sistema: Lab Security Shield v2.0
Clasificaci√≥n: CONFIDENCIAL

---
Este documento contiene informaci√≥n sensible.
Mantenga la confidencialidad apropiada.`;
            
            // Registrar creaci√≥n del reporte
            securityLogs.push({
                timestamp: new Date(),
                type: 'incident_report_created',
                message: `Reporte de incidente ${incidentType} generado`,
                severity: 'warning'
            });
            
            saveSecurityData();
            closeModal();
            
            // Mostrar reporte generado
            openModal(`
                <h2>üìã Reporte de Incidente Generado</h2>
                <div style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 15px; margin: 20px 0; max-height: 400px; overflow-y: auto;">
                    <pre style="white-space: pre-wrap; font-size: 12px; line-height: 1.4;">${incidentReport}</pre>
                </div>
                <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                    <button class="btn btn-alert" onclick="downloadReport('${incidentReport.replace(/'/g, "\\'")}')">üíæ Descargar</button>
                    <button class="btn btn-warning" onclick="emailReport('${incidentReport.replace(/'/g, "\\'")}')">üìß Email</button>
                    <button class="btn btn-safe" onclick="sendReportWhatsApp('${incidentReport.replace(/'/g, "\\'")}')">üì± WhatsApp</button>
                </div>
            `);
        }

        // ========================================
        // üîß ADDITIONAL FUNCTIONS
        // ========================================
        
        function switchCamera(cameraId) {
            const cameras = {
                1: '√Årea Principal - Zona de trabajo',
                2: '√Årea de Almacenamiento - Inventario',
                3: '√Årea de Calidad - Mesa de revisi√≥n'
            };
            
            const placeholder = document.querySelector('.camera-placeholder');
            placeholder.innerHTML = `
                <div style="font-size: 64px; margin-bottom: 15px;">üìπ</div>
                <div>C√°mara ${cameraId} - ${cameras[cameraId]}</div>
                <div style="font-size: 12px; opacity: 0.6; margin-top: 10px;">
                    Resoluci√≥n: 1080p | FPS: 30 | Status: Activa
                </div>
            `;
            
            showNotification(`üìπ Cambiado a C√°mara ${cameraId}`, 'info');
        }

        function recordIncident() {
            showNotification('üìπ Grabaci√≥n de incidente iniciada', 'warning');
            
            securityLogs.push({
                timestamp: new Date(),
                type: 'incident_recording',
                message: 'Grabaci√≥n de incidente iniciada por usuario',
                severity: 'warning'
            });
            
            saveSecurityData();
        }

        function reviewFinances() {
            openModal(`
                <h2>üí∞ Revisi√≥n Financiera Detallada</h2>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin: 20px 0;">
                    <div class="security-metric">
                        <div class="metric-value metric-warning">RD$ ${financialData.totalInLabs.toLocaleString()}</div>
                        <div class="metric-label">Total en Laboratorios</div>
                    </div>
                    <div class="security-metric">
                        <div class="metric-value metric-danger">RD$ ${financialData.unpaidOrders.toLocaleString()}</div>
                        <div class="metric-label">√ìrdenes sin Pagar</div>
                    </div>
                    <div class="security-metric">
                        <div class="metric-value metric-safe">RD$ ${financialData.expectedProfit.toLocaleString()}</div>
                        <div class="metric-label">Beneficio Esperado</div>
                    </div>
                    <div class="security-metric">
                        <div class="metric-value metric-danger">RD$ ${financialData.totalRisk.toLocaleString()}</div>
                        <div class="metric-label">Riesgo Total</div>
                    </div>
                </div>
                
                <div style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 15px; margin: 20px 0;">
                    <h4>üìä An√°lisis por Laboratorio:</h4>
                    <div style="margin: 15px 0;">
                        <div style="display: flex; justify-content: space-between; margin: 10px 0;">
                            <span>üè≠ Lab Central:</span>
                            <span>RD$ 28,450 (Bajo riesgo)</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin: 10px 0;">
                            <span>üè≠ Lab Express:</span>
                            <span>RD$ 16,780 (Riesgo medio)</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin: 10px 0; color: #ff4757;">
                            <span>üè≠ Lab XYZ:</span>
                            <span>RD$ 12,450 (Alto riesgo)</span>
                        </div>
                    </div>
                </div>
                
                <div style="background: rgba(255, 0, 0, 0.1); padding: 15px; border-radius: 10px; border: 1px solid #ff4757;">
                    <h4 style="color: #ff4757;">‚ö†Ô∏è Alertas Financieras:</h4>
                    <ul style="padding-left: 20px; margin: 10px 0;">
                        <li>Lab XYZ: 3 √≥rdenes vencidas sin pagar</li>
                        <li>Exposici√≥n total superior al l√≠mite recomendado</li>
                        <li>Margen de beneficio en riesgo: 41.3%</li>
                    </ul>
                </div>
                
                <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                    <button class="btn btn-warning" onclick="flagRisks()">üö© Marcar Riesgos</button>
                    <button class="btn btn-alert" onclick="freezePayments()">‚ùÑÔ∏è Congelar Pagos</button>
                    <button class="btn btn-security" onclick="generateFinancialReport()">üìä Reporte Financiero</button>
                </div>
            `);
        }

        function flagRisks() {
            // Marcar √≥rdenes de alto riesgo financiero
            orders.forEach(order => {
                if (order.price > 3000 || order.laboratory === 'Lab XYZ') {
                    order.financialFlag = true;
                    order.flagDate = new Date().toISOString();
                }
            });
            
            securityLogs.push({
                timestamp: new Date(),
                type: 'financial_risks_flagged',
                message: '√ìrdenes de alto riesgo financiero marcadas',
                severity: 'warning'
            });
            
            saveSecurityData();
            closeModal();
            showNotification('üö© Riesgos financieros marcados en el sistema', 'warning');
        }

        function sendPaymentReminder() {
            const config = opticaConfig[currentOptica];
            const unpaidOrders = orders.filter(o => o.status !== 'completado' && o.cost > 0);
            
            if (unpaidOrders.length === 0) {
                showNotification('‚úÖ No hay √≥rdenes pendientes de pago', 'success');
                return;
            }
            
            const message = `üí∞ RECORDATORIO DE PAGO\n\nDesde ${config.nombre}\n\nTenemos ${unpaidOrders.length} √≥rdenes pendientes de seguimiento:\n\n${unpaidOrders.slice(0, 5).map(o => `‚Ä¢ ${o.id} - ${o.laboratory} - RD$ ${o.cost.toLocaleString()}`).join('\n')}\n\nFavor coordinar estados de pago.\n\nGracias,\n${config.nombre}\nüì± ${config.telefono}`;
            
            try {
                navigator.clipboard.writeText(message).then(() => {
                    showNotification('üìã Recordatorio de pago copiado. Env√≠alo por WhatsApp.', 'info');
                });
            } catch (error) {
                showNotification('üì± Mensaje de recordatorio preparado', 'info');
            }
        }

        function exportOrdersReport() {
            const config = opticaConfig[currentOptica];
            const report = orders.map(order => {
                return `${order.id} | ${order.client} | ${order.status} | ${order.risk} | RD$ ${order.price} | ${order.laboratory}`;
            }).join('\n');
            
            const fullReport = `üìã REPORTE DE √ìRDENES LAB SECURITY SHIELD

üìÖ Fecha: ${new Date().toLocaleDateString()}
üè¢ Empresa: ${config.nombre}
üì± WhatsApp: ${config.telefono}

üìä RESUMEN:
‚Ä¢ Total √≥rdenes: ${orders.length}
‚Ä¢ En riesgo alto: ${orders.filter(o => o.risk === 'high').length}
‚Ä¢ Completadas: ${orders.filter(o => o.status === 'completado').length}
‚Ä¢ En proceso: ${orders.filter(o => o.status !== 'completado').length}

üìã DETALLE DE √ìRDENES:
ID | Cliente | Estado | Riesgo | Valor | Laboratorio
${report}

üí∞ AN√ÅLISIS FINANCIERO:
‚Ä¢ Valor total: RD$ ${orders.reduce((sum, o) => sum + o.price, 0).toLocaleString()}
‚Ä¢ Costo total: RD$ ${orders.reduce((sum, o) => sum + o.cost, 0).toLocaleString()}
‚Ä¢ Beneficio total: RD$ ${orders.reduce((sum, o) => sum + (o.price - o.cost), 0).toLocaleString()}

üîç ANOMAL√çAS DETECTADAS: ${anomalies.filter(a => !a.resolved).length}

üì± Sistema: Lab Security Shield v2.0
Generado: ${new Date().toISOString()}`;
            
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(fullReport).then(() => {
                    showNotification('üìã Reporte de √≥rdenes copiado', 'success');
                    closeModal();
                });
            } else {
                fallbackCopyReport(fullReport);
                closeModal();
            }
        }

        // ========================================
        // üõ†Ô∏è UTILITY FUNCTIONS
        // ========================================
        
        function openModal(content) {
            document.getElementById('modalContent').innerHTML = content;
            document.getElementById('modal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            
            // Configurar colores seg√∫n el tipo
            notification.className = `notification ${type}`;
            notification.textContent = message;
            notification.classList.add('show');
            
            // Auto-hide despu√©s de 4 segundos
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        // Modal close al hacer clic fuera
        document.getElementById('modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // Auto-save cada 30 segundos
        setInterval(() => {
            saveSecurityData();
            console.log('üíæ Auto-guardado de seguridad ejecutado');
        }, 30000);

        // Cleanup al cerrar
        window.addEventListener('beforeunload', function() {
            saveSecurityData();
            console.log('üßπ Datos de seguridad guardados al cerrar');
        });

        console.log('üõ°Ô∏è Lab Security Shield - Sistema Anti-Robos Cargado');
        console.log('üîç Funciones disponibles:');
        console.log('üìã Order Tracking & Timeline');
        console.log('‚úÖ Quality Control System');
        console.log('üïµÔ∏è AI Anomaly Detection');
        console.log('üìπ Visual Monitoring');
        console.log('üí∞ Financial Security Control');
        console.log('üö® Emergency Response Protocols');
        console.log('üìä Real-time Security Analytics');
        console.log('üì± WhatsApp Integration');
        console.log('üîí Lockdown & Emergency Systems');
        console.log('üõ°Ô∏è ¬°M√ÅXIMA SEGURIDAD ACTIVADA!');
    </script>
</body>
</html>